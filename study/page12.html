<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.48">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <title>C51 | Chenxuwkk's Blog</title><meta name="description" content="Chenxuwkk's Blog">
    <link rel="modulepreload" href="/blog/assets/app.b33ca31f.js"><link rel="modulepreload" href="/blog/assets/page12.html.29d2532a.js"><link rel="modulepreload" href="/blog/assets/page12.html.1814d2d6.js"><link rel="prefetch" href="/blog/assets/about.html.1a741a35.js"><link rel="prefetch" href="/blog/assets/contact.html.03aacf5e.js"><link rel="prefetch" href="/blog/assets/index.html.2e04d9b1.js"><link rel="prefetch" href="/blog/assets/index.html.dc88bf6f.js"><link rel="prefetch" href="/blog/assets/page01.html.6f1784f0.js"><link rel="prefetch" href="/blog/assets/index.html.b2e428a6.js"><link rel="prefetch" href="/blog/assets/page01.html.8647912c.js"><link rel="prefetch" href="/blog/assets/page02.html.2ae31539.js"><link rel="prefetch" href="/blog/assets/page03.html.e30663aa.js"><link rel="prefetch" href="/blog/assets/page04.html.5b5a177e.js"><link rel="prefetch" href="/blog/assets/page05.html.8dc876d3.js"><link rel="prefetch" href="/blog/assets/index.html.1faed378.js"><link rel="prefetch" href="/blog/assets/page00.html.397ec4cb.js"><link rel="prefetch" href="/blog/assets/page01.html.d4c49eb5.js"><link rel="prefetch" href="/blog/assets/page02.html.512e9f97.js"><link rel="prefetch" href="/blog/assets/page03.html.07c7a8d5.js"><link rel="prefetch" href="/blog/assets/page04.html.ea9d586c.js"><link rel="prefetch" href="/blog/assets/page05.html.c54831cd.js"><link rel="prefetch" href="/blog/assets/page06.html.130549e7.js"><link rel="prefetch" href="/blog/assets/page07.html.7c7f84ea.js"><link rel="prefetch" href="/blog/assets/page08.html.e3c59864.js"><link rel="prefetch" href="/blog/assets/page09.html.4785a4a4.js"><link rel="prefetch" href="/blog/assets/page10.html.c6168586.js"><link rel="prefetch" href="/blog/assets/page11.html.ce54a18d.js"><link rel="prefetch" href="/blog/assets/page13.html.3976787d.js"><link rel="prefetch" href="/blog/assets/page14.html.810a54e6.js"><link rel="prefetch" href="/blog/assets/page15.html.3ad37cea.js"><link rel="prefetch" href="/blog/assets/page16.html.c8b15e87.js"><link rel="prefetch" href="/blog/assets/page17.html.bda23cdd.js"><link rel="prefetch" href="/blog/assets/page18.html.8e431832.js"><link rel="prefetch" href="/blog/assets/page19.html.4f7e6a54.js"><link rel="prefetch" href="/blog/assets/page20.html.53b884d3.js"><link rel="prefetch" href="/blog/assets/page21.html.ea7e75ec.js"><link rel="prefetch" href="/blog/assets/page22.html.6a8a8911.js"><link rel="prefetch" href="/blog/assets/page23.html.4da8711b.js"><link rel="prefetch" href="/blog/assets/page24.html.f15f76b8.js"><link rel="prefetch" href="/blog/assets/page25.html.47a43782.js"><link rel="prefetch" href="/blog/assets/index.html.09d3b996.js"><link rel="prefetch" href="/blog/assets/404.html.265028f6.js"><link rel="prefetch" href="/blog/assets/about.html.7c2de1fc.js"><link rel="prefetch" href="/blog/assets/contact.html.af265cd3.js"><link rel="prefetch" href="/blog/assets/index.html.494633a3.js"><link rel="prefetch" href="/blog/assets/index.html.6f6ef67c.js"><link rel="prefetch" href="/blog/assets/page01.html.24477c8b.js"><link rel="prefetch" href="/blog/assets/index.html.06f044c7.js"><link rel="prefetch" href="/blog/assets/page01.html.2c2c82ac.js"><link rel="prefetch" href="/blog/assets/page02.html.519c6760.js"><link rel="prefetch" href="/blog/assets/page03.html.9c782bee.js"><link rel="prefetch" href="/blog/assets/page04.html.01792834.js"><link rel="prefetch" href="/blog/assets/page05.html.ecd56c0e.js"><link rel="prefetch" href="/blog/assets/index.html.0d805a32.js"><link rel="prefetch" href="/blog/assets/page00.html.b5b8a137.js"><link rel="prefetch" href="/blog/assets/page01.html.196f31d8.js"><link rel="prefetch" href="/blog/assets/page02.html.446eff9c.js"><link rel="prefetch" href="/blog/assets/page03.html.265319dc.js"><link rel="prefetch" href="/blog/assets/page04.html.839ac225.js"><link rel="prefetch" href="/blog/assets/page05.html.3ba90d93.js"><link rel="prefetch" href="/blog/assets/page06.html.5ec3bc24.js"><link rel="prefetch" href="/blog/assets/page07.html.9811e105.js"><link rel="prefetch" href="/blog/assets/page08.html.550b989b.js"><link rel="prefetch" href="/blog/assets/page09.html.e59328fe.js"><link rel="prefetch" href="/blog/assets/page10.html.42d79a00.js"><link rel="prefetch" href="/blog/assets/page11.html.07064880.js"><link rel="prefetch" href="/blog/assets/page13.html.31c29b64.js"><link rel="prefetch" href="/blog/assets/page14.html.ad9dcffb.js"><link rel="prefetch" href="/blog/assets/page15.html.58f3b33b.js"><link rel="prefetch" href="/blog/assets/page16.html.8841620e.js"><link rel="prefetch" href="/blog/assets/page17.html.bc75eefa.js"><link rel="prefetch" href="/blog/assets/page18.html.467eb0c9.js"><link rel="prefetch" href="/blog/assets/page19.html.55cbf803.js"><link rel="prefetch" href="/blog/assets/page20.html.8b45092f.js"><link rel="prefetch" href="/blog/assets/page21.html.cc2b2ea3.js"><link rel="prefetch" href="/blog/assets/page22.html.d7349c76.js"><link rel="prefetch" href="/blog/assets/page23.html.e468a4f1.js"><link rel="prefetch" href="/blog/assets/page24.html.af7dd849.js"><link rel="prefetch" href="/blog/assets/page25.html.b0d918c5.js"><link rel="prefetch" href="/blog/assets/index.html.1b0cec2a.js"><link rel="prefetch" href="/blog/assets/404.html.b1b48cf0.js"><link rel="prefetch" href="/blog/assets/404.515c5f58.js"><link rel="prefetch" href="/blog/assets/Layout.14a38178.js"><link rel="prefetch" href="/blog/assets/auto.esm.36809f22.js"><link rel="prefetch" href="/blog/assets/index.daae04bf.js"><link rel="prefetch" href="/blog/assets/index.1842ee54.js"><link rel="prefetch" href="/blog/assets/mermaid.esm.min.ee1e0284.js">
    <link rel="stylesheet" href="/blog/assets/style.f6d73350.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><img class="logo" src="/blog/assets/img/logo.png" alt="Chenxuwkk&#39;s Blog"><span class="site-name can-hide">Chenxuwkk&#39;s Blog</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="导航"><span class="title">导航</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="导航"><span class="title">导航</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/study/page01" class="" aria-label="学习记录"><!--[--><!--]--> 学习记录 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/question/page01" class="" aria-label="疑难问题"><!--[--><!--]--> 疑难问题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/manuscript/page01" class="" aria-label="草稿本"><!--[--><!--]--> 草稿本 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/contact" class="" aria-label="联系本人"><!--[--><!--]--> 联系本人 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/about/" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/Chenxuwkk" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-color-mode-button" title="toggle color mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a href="/blog/" class="" aria-label="首页"><!--[--><!--]--> 首页 <!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="导航"><span class="title">导航</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="导航"><span class="title">导航</span><span class="right arrow"></span></button><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/blog/guide/" class="" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/study/page01" class="" aria-label="学习记录"><!--[--><!--]--> 学习记录 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/question/page01" class="" aria-label="疑难问题"><!--[--><!--]--> 疑难问题 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/manuscript/page01" class="" aria-label="草稿本"><!--[--><!--]--> 草稿本 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/contact" class="" aria-label="联系本人"><!--[--><!--]--> 联系本人 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/blog/about/" class="" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a></li><!--]--></ul></div></div><div class="navbar-item"><a class="external-link" href="https://github.com/Chenxuwkk" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/blog/guide/" class="sidebar-item sidebar-heading" aria-label="指南"><!--[--><!--]--> 指南 <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">学习记录 <!----></p><ul style="" class="sidebar-item-children"><!--[--><li><a href="/blog/study/page01.html" class="sidebar-item" aria-label="Vuepress部署"><!--[--><!--]--> Vuepress部署 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page03.html" class="sidebar-item" aria-label="Linux 命令"><!--[--><!--]--> Linux 命令 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page02.html" class="sidebar-item" aria-label="C语言预处理"><!--[--><!--]--> C语言预处理 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page04.html" class="sidebar-item" aria-label="C语言位运算"><!--[--><!--]--> C语言位运算 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page05.html" class="sidebar-item" aria-label="C语言指针"><!--[--><!--]--> C语言指针 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page07.html" class="sidebar-item" aria-label="C语言动态内存"><!--[--><!--]--> C语言动态内存 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page08.html" class="sidebar-item" aria-label="C语言字符串处理"><!--[--><!--]--> C语言字符串处理 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page09.html" class="sidebar-item" aria-label="C语言结构体详解"><!--[--><!--]--> C语言结构体详解 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page10.html" class="sidebar-item" aria-label="C语言链表"><!--[--><!--]--> C语言链表 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page21.html" class="sidebar-item" aria-label="C++对C语言的加强"><!--[--><!--]--> C++对C语言的加强 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page06.html" class="sidebar-item" aria-label="Markdown高级技巧"><!--[--><!--]--> Markdown高级技巧 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page11.html" class="sidebar-item" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="C51"><!--[--><!--]--> C51 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/study/page12.html#拓展变量" class="router-link-active router-link-exact-active sidebar-item" aria-label="拓展变量"><!--[--><!--]--> 拓展变量 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#注意事项" class="router-link-active router-link-exact-active sidebar-item" aria-label="注意事项"><!--[--><!--]--> 注意事项 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#led流水灯实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="LED流水灯实验"><!--[--><!--]--> LED流水灯实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#蜂鸣器实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="蜂鸣器实验"><!--[--><!--]--> 蜂鸣器实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#动态数码管实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="动态数码管实验"><!--[--><!--]--> 动态数码管实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#独立按键实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="独立按键实验"><!--[--><!--]--> 独立按键实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#矩阵按键" class="router-link-active router-link-exact-active sidebar-item" aria-label="矩阵按键"><!--[--><!--]--> 矩阵按键 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#i-o拓展-串转并-实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="I/O拓展(串转并)实验"><!--[--><!--]--> I/O拓展(串转并)实验 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/study/page12.html#延迟函数" class="router-link-active router-link-exact-active sidebar-item" aria-label="延迟函数"><!--[--><!--]--> 延迟函数 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#从高位逐位取数据" class="router-link-active router-link-exact-active sidebar-item" aria-label="从高位逐位取数据"><!--[--><!--]--> 从高位逐位取数据 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#完整代码" class="router-link-active router-link-exact-active sidebar-item" aria-label="完整代码"><!--[--><!--]--> 完整代码 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#多块595拓展i-o" class="router-link-active router-link-exact-active sidebar-item" aria-label="多块595拓展I/O"><!--[--><!--]--> 多块595拓展I/O <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/blog/study/page12.html#led点阵" class="router-link-active router-link-exact-active sidebar-item" aria-label="LED点阵"><!--[--><!--]--> LED点阵 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#直流电机" class="router-link-active router-link-exact-active sidebar-item" aria-label="直流电机"><!--[--><!--]--> 直流电机 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#步进电机" class="router-link-active router-link-exact-active sidebar-item" aria-label="步进电机"><!--[--><!--]--> 步进电机 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#外部中断实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="外部中断实验"><!--[--><!--]--> 外部中断实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#定时器中断" class="router-link-active router-link-exact-active sidebar-item" aria-label="定时器中断"><!--[--><!--]--> 定时器中断 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#串口通信实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="串口通信实验"><!--[--><!--]--> 串口通信实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#i2c-eeprom实验" class="router-link-active router-link-exact-active sidebar-item" aria-label="I2C-EEPROM实验"><!--[--><!--]--> I2C-EEPROM实验 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#温度传感器ds18b20" class="router-link-active router-link-exact-active sidebar-item" aria-label="温度传感器DS18B20"><!--[--><!--]--> 温度传感器DS18B20 <!--[--><!--]--></a><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/blog/study/page12.html#初始化时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="初始化时序"><!--[--><!--]--> 初始化时序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#写时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="写时序"><!--[--><!--]--> 写时序 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#读时序" class="router-link-active router-link-exact-active sidebar-item" aria-label="读时序"><!--[--><!--]--> 读时序 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a aria-current="page" href="/blog/study/page12.html#时钟芯片ds1302" class="router-link-active router-link-exact-active sidebar-item" aria-label="时钟芯片DS1302"><!--[--><!--]--> 时钟芯片DS1302 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#红外遥控" class="router-link-active router-link-exact-active sidebar-item" aria-label="红外遥控"><!--[--><!--]--> 红外遥控 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#adc模数转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="ADC模数转换"><!--[--><!--]--> ADC模数转换 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#dac数模转换" class="router-link-active router-link-exact-active sidebar-item" aria-label="DAC数模转换"><!--[--><!--]--> DAC数模转换 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#lcd1602" class="router-link-active router-link-exact-active sidebar-item" aria-label="LCD1602"><!--[--><!--]--> LCD1602 <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/blog/study/page12.html#esp8266" class="router-link-active router-link-exact-active sidebar-item" aria-label="ESP8266"><!--[--><!--]--> ESP8266 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/blog/study/page13.html" class="sidebar-item" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page14.html" class="sidebar-item" aria-label="嵌入式小记"><!--[--><!--]--> 嵌入式小记 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page15.html" class="sidebar-item" aria-label="IMRD"><!--[--><!--]--> IMRD <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page17.html" class="sidebar-item" aria-label="Paxos算法"><!--[--><!--]--> Paxos算法 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page18.html" class="sidebar-item" aria-label="STL"><!--[--><!--]--> STL <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page19.html" class="sidebar-item" aria-label="Python"><!--[--><!--]--> Python <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page16.html" class="sidebar-item" aria-label="Leetcode"><!--[--><!--]--> Leetcode <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page20.html" class="sidebar-item" aria-label="剑指Offer"><!--[--><!--]--> 剑指Offer <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page22.html" class="sidebar-item" aria-label="剑指Offer II"><!--[--><!--]--> 剑指Offer II <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page23.html" class="sidebar-item" aria-label="二分专项"><!--[--><!--]--> 二分专项 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page24.html" class="sidebar-item" aria-label="动态规划专项"><!--[--><!--]--> 动态规划专项 <!--[--><!--]--></a><!----></li><li><a href="/blog/study/page25.html" class="sidebar-item" aria-label="SQL"><!--[--><!--]--> SQL <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><p tabindex="0" class="sidebar-item sidebar-heading collapsible">疑难问题 <span class="right arrow"></span></p><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/blog/question/page01.html" class="sidebar-item" aria-label="Git同步 😄"><!--[--><!--]--> Git同步 😄 <!--[--><!--]--></a><!----></li><li><a href="/blog/question/page02.html" class="sidebar-item" aria-label="Ubantu内存重新分配（Vmware） 🍎"><!--[--><!--]--> Ubantu内存重新分配（Vmware） 🍎 <!--[--><!--]--></a><!----></li><li><a href="/blog/question/page03.html" class="sidebar-item" aria-label="一个个小坑（Vue） 💢"><!--[--><!--]--> 一个个小坑（Vue） 💢 <!--[--><!--]--></a><!----></li><li><a href="/blog/question/page04.html" class="sidebar-item" aria-label="VSCode编译C\C++"><!--[--><!--]--> VSCode编译C\C++ <!--[--><!--]--></a><!----></li><li><a href="/blog/question/page05.html" class="sidebar-item" aria-label="代码复现问题"><!--[--><!--]--> 代码复现问题 <!--[--><!--]--></a><!----></li><!--]--></ul></li><li><a href="/blog/manuscript/page01" class="sidebar-item sidebar-heading" aria-label="草稿本"><!--[--><!--]--> 草稿本 <!--[--><!--]--></a><!----></li><li><a href="/blog/contact" class="sidebar-item sidebar-heading collapsible" aria-label="联系本人"><!--[--><!--]--> 联系本人 <!--[--><!--]--></a><!----></li><li><a href="/blog/about" class="sidebar-item sidebar-heading" aria-label="关于"><!--[--><!--]--> 关于 <!--[--><!--]--></a><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><!--]--><div><h1 id="c51" tabindex="-1"><a class="header-anchor" href="#c51" aria-hidden="true">#</a> C51</h1><hr><nav class="table-of-contents"><ul><li><a aria-current="page" href="/blog/study/page12.html#拓展变量" class="router-link-active router-link-exact-active">拓展变量</a></li><li><a aria-current="page" href="/blog/study/page12.html#注意事项" class="router-link-active router-link-exact-active">注意事项</a></li><li><a aria-current="page" href="/blog/study/page12.html#led流水灯实验" class="router-link-active router-link-exact-active">LED流水灯实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#蜂鸣器实验" class="router-link-active router-link-exact-active">蜂鸣器实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#动态数码管实验" class="router-link-active router-link-exact-active">动态数码管实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#独立按键实验" class="router-link-active router-link-exact-active">独立按键实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#矩阵按键" class="router-link-active router-link-exact-active">矩阵按键</a></li><li><a aria-current="page" href="/blog/study/page12.html#i-o拓展-串转并-实验" class="router-link-active router-link-exact-active">I/O拓展(串转并)实验</a><ul><li><a aria-current="page" href="/blog/study/page12.html#延迟函数" class="router-link-active router-link-exact-active">延迟函数</a></li><li><a aria-current="page" href="/blog/study/page12.html#从高位逐位取数据" class="router-link-active router-link-exact-active">从高位逐位取数据</a></li><li><a aria-current="page" href="/blog/study/page12.html#完整代码" class="router-link-active router-link-exact-active">完整代码</a></li><li><a aria-current="page" href="/blog/study/page12.html#多块595拓展i-o" class="router-link-active router-link-exact-active">多块595拓展I/O</a></li></ul></li><li><a aria-current="page" href="/blog/study/page12.html#led点阵" class="router-link-active router-link-exact-active">LED点阵</a></li><li><a aria-current="page" href="/blog/study/page12.html#直流电机" class="router-link-active router-link-exact-active">直流电机</a></li><li><a aria-current="page" href="/blog/study/page12.html#步进电机" class="router-link-active router-link-exact-active">步进电机</a></li><li><a aria-current="page" href="/blog/study/page12.html#外部中断实验" class="router-link-active router-link-exact-active">外部中断实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#定时器中断" class="router-link-active router-link-exact-active">定时器中断</a></li><li><a aria-current="page" href="/blog/study/page12.html#串口通信实验" class="router-link-active router-link-exact-active">串口通信实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#i2c-eeprom实验" class="router-link-active router-link-exact-active">I2C-EEPROM实验</a></li><li><a aria-current="page" href="/blog/study/page12.html#温度传感器ds18b20" class="router-link-active router-link-exact-active">温度传感器DS18B20</a><ul><li><a aria-current="page" href="/blog/study/page12.html#初始化时序" class="router-link-active router-link-exact-active">初始化时序</a></li><li><a aria-current="page" href="/blog/study/page12.html#写时序" class="router-link-active router-link-exact-active">写时序</a></li><li><a aria-current="page" href="/blog/study/page12.html#读时序" class="router-link-active router-link-exact-active">读时序</a></li></ul></li><li><a aria-current="page" href="/blog/study/page12.html#时钟芯片ds1302" class="router-link-active router-link-exact-active">时钟芯片DS1302</a></li><li><a aria-current="page" href="/blog/study/page12.html#红外遥控" class="router-link-active router-link-exact-active">红外遥控</a></li><li><a aria-current="page" href="/blog/study/page12.html#adc模数转换" class="router-link-active router-link-exact-active">ADC模数转换</a></li><li><a aria-current="page" href="/blog/study/page12.html#dac数模转换" class="router-link-active router-link-exact-active">DAC数模转换</a></li><li><a aria-current="page" href="/blog/study/page12.html#lcd1602" class="router-link-active router-link-exact-active">LCD1602</a></li><li><a aria-current="page" href="/blog/study/page12.html#esp8266" class="router-link-active router-link-exact-active">ESP8266</a></li></ul></nav><h2 id="拓展变量" tabindex="-1"><a class="header-anchor" href="#拓展变量" aria-hidden="true">#</a> 拓展变量</h2><table><thead><tr><th style="text-align:left;">变量</th><th style="text-align:left;">位</th><th style="text-align:left;">范围</th><th style="text-align:left;">作用</th></tr></thead><tbody><tr><td style="text-align:left;"><code>bit</code></td><td style="text-align:left;">1</td><td style="text-align:left;">1或0</td><td style="text-align:left;">位变量声明</td></tr><tr><td style="text-align:left;"><code>sbit</code></td><td style="text-align:left;">1</td><td style="text-align:left;">1或0</td><td style="text-align:left;">特殊功能位声明</td></tr><tr><td style="text-align:left;"><code>sfr</code></td><td style="text-align:left;">8</td><td style="text-align:left;">0-255</td><td style="text-align:left;">特殊功能寄存器</td></tr><tr><td style="text-align:left;"><code>sfr16</code></td><td style="text-align:left;">16</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;"><code>*</code></td><td style="text-align:left;">1-3字节</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;"><code>unsigned char</code></td><td style="text-align:left;">8</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr><tr><td style="text-align:left;"><code>unsigned int</code></td><td style="text-align:left;">16</td><td style="text-align:left;"></td><td style="text-align:left;"></td></tr></tbody></table><h2 id="注意事项" tabindex="-1"><a class="header-anchor" href="#注意事项" aria-hidden="true">#</a> 注意事项</h2><ol><li><p><code>数码管</code>/<code>hc595</code> 消影，每次传输<code>前</code>/<code>后</code>传<code>0x00</code>置位(共阴)</p></li><li><p><strong>定义变量要在最前面</strong></p></li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LEDDZ_COL_PORT <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token comment">//如果上两句颠倒会报错:</span>
<span class="token comment">//MAIN.C(82): error C141: syntax error near &#39;u8&#39;</span>
<span class="token comment">//MAIN.C(82): error C202: &#39;i&#39;: undefined identifier</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="led流水灯实验" tabindex="-1"><a class="header-anchor" href="#led流水灯实验" aria-hidden="true">#</a> LED流水灯实验</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;intrins.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PORT</span>	<span class="token expression">P2	</span><span class="token comment">//使用宏定义P2端口</span></span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
   	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	LED_PORT<span class="token operator">=</span><span class="token operator">~</span><span class="token number">0x01</span><span class="token punctuation">;</span><span class="token comment">//1111 1110 PO端口有上拉电阻，故拉低电流LED亮</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//方法1：使用移位+循环实现流水灯</span>
<span class="token comment">//		for(i=0;i&lt;8;i++)</span>
<span class="token comment">//		{</span>
<span class="token comment">//			LED_PORT=~(0x01&lt;&lt;i);	//将1右移i位，然后取反将结果赋值到LED_PORT</span>
<span class="token comment">//			delay_10us(50000);</span>
<span class="token comment">//		}</span>
		
		<span class="token comment">//方法2：使用循环+_crol_或_cror_函数实现流水灯</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>	 <span class="token comment">//将led左移一位</span>
		<span class="token punctuation">{</span>									  
			LED_PORT<span class="token operator">=</span><span class="token function">_crol_</span><span class="token punctuation">(</span>LED_PORT<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//循环左移</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 	
		<span class="token punctuation">}</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>	<span class="token comment">//将led右移一位</span>
		<span class="token punctuation">{</span>
			LED_PORT<span class="token operator">=</span><span class="token function">_cror_</span><span class="token punctuation">(</span>LED_PORT<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//循环右移</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="蜂鸣器实验" tabindex="-1"><a class="header-anchor" href="#蜂鸣器实验" aria-hidden="true">#</a> 蜂鸣器实验</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

sbit BEEP<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span>	<span class="token comment">//将P2.5管脚定义为BEEP</span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u16 i<span class="token operator">=</span><span class="token number">2000</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	<span class="token keyword">while</span><span class="token punctuation">(</span>i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token comment">//循环2000次</span>
		<span class="token punctuation">{</span>
			BEEP<span class="token operator">=</span><span class="token operator">!</span>BEEP<span class="token punctuation">;</span><span class="token comment">//产生一定频率的脉冲信号</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//清零</span>
		BEEP<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//关闭蜂鸣器</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="动态数码管实验" tabindex="-1"><a class="header-anchor" href="#动态数码管实验" aria-hidden="true">#</a> 动态数码管实验</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMG_A_DP_PORT</span>	<span class="token expression">P0	</span><span class="token comment">//使用宏定义数码管段码口</span></span>

<span class="token comment">//定义数码管位选信号控制脚</span>
sbit LSA<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit LSB<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>
sbit LSC<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">//共阴极数码管显示0~F的段码数据</span>
u8 gsmg_code<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5b</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span>
				<span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x71</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">smg_display</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	<span class="token keyword">switch</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">//位选</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//7</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//6</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//5</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//4</span>
			<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//3</span>
			<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//2</span>
			<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//1</span>
			<span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//0</span>
		<span class="token punctuation">}</span>
		SMG_A_DP_PORT<span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>i<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//传送段选数据</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时一段时间，等待显示稳定</span>
		SMG_A_DP_PORT<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span><span class="token comment">//消音</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	<span class="token function">smg_display</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="独立按键实验" tabindex="-1"><a class="header-anchor" href="#独立按键实验" aria-hidden="true">#</a> 独立按键实验</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义独立按键控制脚</span>
sbit KEY1<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit KEY2<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit KEY3<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit KEY4<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">//定义LED1控制脚</span>
sbit LED1<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit LED2<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit LED3<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit LED4<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>
<span class="token comment">//使用宏定义独立按键按下的键值</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_PRESS</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_PRESS</span>	<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY3_PRESS</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY4_PRESS</span>	<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UNPRESS</span>	<span class="token expression"><span class="token number">0</span>	</span></span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">//mode=0：单次扫描按键</span>
<span class="token comment">//mode=1：连续扫描按键</span>
<span class="token comment">//KEY1_PRESS：K1按下</span>
<span class="token comment">//KEY2_PRESS：K2按下</span>
<span class="token comment">//KEY3_PRESS：K3按下</span>
<span class="token comment">//KEY4_PRESS：K4按下</span>
<span class="token comment">//KEY_UNPRESS：未有按键按下</span>

u8 <span class="token function">key_scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u8 key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//连续扫描按键</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//任意按键按下  按下为0</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按键一按下时会产生一连串的抖动</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY1_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY2_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY3_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY4_PRESS<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY2<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY3<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY4<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//无按键按下</span>
	<span class="token punctuation">{</span>
		key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>			
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> KEY_UNPRESS<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	key<span class="token operator">=</span><span class="token function">key_scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY1_PRESS<span class="token punctuation">)</span><span class="token comment">//检测按键K1是否按下</span>
		<span class="token punctuation">{</span>	  
		 	LED1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//LED1状态翻转	</span>
			LED2<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
			LED3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY2_PRESS<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			LED1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			LED2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			LED3<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY3_PRESS<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			LED1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			LED2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			LED3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY4_PRESS<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>
			LED2<span class="token operator">=</span><span class="token operator">!</span>LED2<span class="token punctuation">;</span>
			LED3<span class="token operator">=</span><span class="token operator">!</span>LED3<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="矩阵按键" tabindex="-1"><a class="header-anchor" href="#矩阵按键" aria-hidden="true">#</a> 矩阵按键</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_MATRIX_PORT</span>	<span class="token expression">P1	</span><span class="token comment">//使用宏定义矩阵按键控制口		</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMG_A_DP_PORT</span>	<span class="token expression">P0	</span><span class="token comment">//使用宏定义数码管段码口</span></span>

<span class="token comment">//共阴极数码管显示0~F的段码数据</span>
u8 gsmg_code<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5b</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span>
				<span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x71</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
* 函 数 名       : key_matrix_ranks_scan
* 函数功能		 : 使用行列式扫描方法，检测矩阵按键是否按下，按下则返回对应键值
* 输    入       : 无
* 输    出    	 : key_value：1-16，对应S1-S16键，
				   0：按键未按下
*******************************************************************************/</span>
u8 <span class="token function">key_matrix_ranks_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>		<span class="token comment">//行列同时检测</span>
<span class="token punctuation">{</span>
	u8 key_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0xf7</span><span class="token punctuation">;</span><span class="token comment">//给第一列赋值0，其余全为1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xf7</span><span class="token punctuation">)</span><span class="token comment">//判断第一列按键是否按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存第一列按键按下后的键值	</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x77</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xb7</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xd7</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">9</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xe7</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">13</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xf7</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键松开	</span>
	
	KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0xfb</span><span class="token punctuation">;</span><span class="token comment">//给第二列赋值0，其余全为1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfb</span><span class="token punctuation">)</span><span class="token comment">//判断第二列按键是否按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存第二列按键按下后的键值	</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x7b</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xbb</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xdb</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xeb</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">14</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfb</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键松开	</span>
	
	KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0xfd</span><span class="token punctuation">;</span><span class="token comment">//给第三列赋值0，其余全为1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfd</span><span class="token punctuation">)</span><span class="token comment">//判断第三列按键是否按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存第三列按键按下后的键值	</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x7d</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xbd</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xdd</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">11</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xed</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">15</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfd</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键松开	</span>
	
	KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0xfe</span><span class="token punctuation">;</span><span class="token comment">//给第四列赋值0，其余全为1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfe</span><span class="token punctuation">)</span><span class="token comment">//判断第四列按键是否按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存第四列按键按下后的键值	</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0x7e</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xbe</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xde</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">12</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token keyword">case</span> <span class="token number">0xee</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">16</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xfe</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键松开</span>
	
	<span class="token keyword">return</span> key_value<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token comment">/*******************************************************************************
* 函 数 名       : key_matrix_flip_scan
* 函数功能		 : 使用线翻转扫描方法，检测矩阵按键是否按下，按下则返回对应键值
* 输    入       : 无
* 输    出    	 : key_value：1-16，对应S1-S16键，
				   0：按键未按下
*******************************************************************************/</span>
u8 <span class="token function">key_matrix_flip_scan</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>	  <span class="token comment">//先看列，再看行</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u8 key_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0x0f</span><span class="token punctuation">;</span><span class="token comment">//给所有行赋值0，列全为1</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0x0f</span><span class="token punctuation">)</span><span class="token comment">//判断按键是否按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0x0f</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token comment">//测试列</span>
			KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0x0f</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存行为0，按键按下后的列值	</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">case</span> <span class="token number">0x07</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0x0b</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0x0d</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">3</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0x0e</span><span class="token operator">:</span> key_value<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token comment">//测试行</span>
			KEY_MATRIX_PORT<span class="token operator">=</span><span class="token number">0xf0</span><span class="token punctuation">;</span>
			<span class="token keyword">switch</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token punctuation">)</span><span class="token comment">//保存列为0，按键按下后的键值	</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">case</span> <span class="token number">0x70</span><span class="token operator">:</span> key_value<span class="token operator">=</span>key_value<span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0xb0</span><span class="token operator">:</span> key_value<span class="token operator">=</span>key_value<span class="token operator">+</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0xd0</span><span class="token operator">:</span> key_value<span class="token operator">=</span>key_value<span class="token operator">+</span><span class="token number">8</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token keyword">case</span> <span class="token number">0xe0</span><span class="token operator">:</span> key_value<span class="token operator">=</span>key_value<span class="token operator">+</span><span class="token number">12</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span>KEY_MATRIX_PORT<span class="token operator">!=</span><span class="token number">0xf0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//等待按键松开	</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>
		key_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		
	
	<span class="token keyword">return</span> key_value<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	key<span class="token operator">=</span><span class="token function">key_matrix_ranks_scan</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
			SMG_A_DP_PORT<span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>key<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//得到的按键值减1换算成数组下标对应0-F段码		</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="i-o拓展-串转并-实验" tabindex="-1"><a class="header-anchor" href="#i-o拓展-串转并-实验" aria-hidden="true">#</a> I/O拓展(串转并)实验</h2><p><img src="https://img30.360buyimg.com/pop/jfs/t1/212425/31/15286/46165/62371c83Eaa2cc6d0/aaa88727929ea2e3.png" alt="image-20220319172533942.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/99786/12/26521/41553/62371c96Eef6057f2/d3f6f8a8be10e2b8.png" alt="image-20220319172558201.png"></p><h3 id="延迟函数" tabindex="-1"><a class="header-anchor" href="#延迟函数" aria-hidden="true">#</a> 延迟函数</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment">//12MHz下大约10us</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">100</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span>ms<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="从高位逐位取数据" tabindex="-1"><a class="header-anchor" href="#从高位逐位取数据" aria-hidden="true">#</a> 从高位逐位取数据</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//hc595</span>
<span class="token keyword">void</span> <span class="token function">hc595_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按位，从高取</span>
		SER <span class="token operator">=</span> dat<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	RCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//移位寄存器送入存储寄存器中</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="完整代码" tabindex="-1"><a class="header-anchor" href="#完整代码" aria-hidden="true">#</a> 完整代码</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义74HC595控制管脚</span>
sbit SRCLK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span>	<span class="token comment">//移位寄存器时钟输入</span>
sbit rCLK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span>		<span class="token comment">//存储寄存器时钟输入</span>
sbit SER<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span> 		<span class="token comment">//串行数据输入</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LEDDZ_COL_PORT</span>	<span class="token expression">P0	</span><span class="token comment">//点阵列控制端口</span></span>

u8 ghc595_buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x01</span><span class="token punctuation">,</span><span class="token number">0x02</span><span class="token punctuation">,</span><span class="token number">0x04</span><span class="token punctuation">,</span><span class="token number">0x08</span><span class="token punctuation">,</span><span class="token number">0x10</span><span class="token punctuation">,</span><span class="token number">0x20</span><span class="token punctuation">,</span><span class="token number">0x40</span><span class="token punctuation">,</span><span class="token number">0x80</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>ms<span class="token punctuation">;</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">;</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">hc595_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按位，从高取</span>
		SER <span class="token operator">=</span> dat<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	rCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//移位寄存器送入存储寄存器中</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LEDDZ_COL_PORT <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>	
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">hc595_write_data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消影</span>
			<span class="token function">hc595_write_data</span><span class="token punctuation">(</span>ghc595_buf<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">50000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>			
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="多块595拓展i-o" tabindex="-1"><a class="header-anchor" href="#多块595拓展i-o" aria-hidden="true">#</a> 多块595拓展I/O</h3><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//4*hc595</span>
<span class="token keyword">void</span> <span class="token function">hc595_write_data</span><span class="token punctuation">(</span>u8 dat1<span class="token punctuation">,</span>u8 dat2<span class="token punctuation">,</span>u8 dat3<span class="token punctuation">,</span>u8 dat4<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		SER <span class="token operator">=</span> dat4<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat4<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按位，从高取</span>
		SER <span class="token operator">=</span> dat3<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat3<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按位，从高取</span>
		SER <span class="token operator">=</span> dat2<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat2<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
    	<span class="token keyword">for</span><span class="token punctuation">(</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按位，从高取</span>
		SER <span class="token operator">=</span> dat1<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//将最高位右移到最低位，高位全部补0</span>
		dat1<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//dat = dat &lt;&lt; 1 将最高位再顶掉，下一轮循环再右移7位</span>
		<span class="token comment">//为了要上升沿 低电平读取数据</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//送入移位寄存器中</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	RCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//移位寄存器送入存储寄存器中</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	RCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token comment">//相当于4片串联595是一个4*8位的移位寄存器</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="led点阵" tabindex="-1"><a class="header-anchor" href="#led点阵" aria-hidden="true">#</a> LED点阵</h2><p><strong>简单点亮一个灯</strong></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PORT</span> <span class="token expression">P0</span></span>

sbit SRCLK <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//移位寄存器时钟</span>
sbit rCLK <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//存储寄存器时钟</span>
sbit SER <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//串行输入595</span>
	 
<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">hc595_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		SER <span class="token operator">=</span> dat<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
		dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	rCLK <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rCLK <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 LED_DZ <span class="token operator">=</span> <span class="token number">0x80</span><span class="token punctuation">;</span>
	LED_PORT <span class="token operator">=</span> <span class="token operator">~</span><span class="token number">0x80</span><span class="token punctuation">;</span>
	
	<span class="token function">hc595_write_data</span><span class="token punctuation">(</span>LED_DZ<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
				
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>列扫描显示</strong>❤️</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED_PORT</span> <span class="token expression">P0</span></span>

sbit SRCLK <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//移位寄存器时钟</span>
sbit rCLK <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//存储寄存器时钟</span>
sbit SER <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//串行输入595</span>

u8 gled_row<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x00</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x11</span><span class="token punctuation">,</span><span class="token number">0x22</span><span class="token punctuation">,</span><span class="token number">0x44</span><span class="token punctuation">,</span><span class="token number">0x38</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
u8 gled_col<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0xbf</span><span class="token punctuation">,</span><span class="token number">0xdf</span><span class="token punctuation">,</span><span class="token number">0xef</span><span class="token punctuation">,</span><span class="token number">0xf7</span><span class="token punctuation">,</span><span class="token number">0xfb</span><span class="token punctuation">,</span><span class="token number">0xfd</span><span class="token punctuation">,</span><span class="token number">0xfe</span><span class="token punctuation">}</span><span class="token punctuation">;</span>	 
<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">hc595_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		SER <span class="token operator">=</span> dat<span class="token operator">&gt;&gt;</span><span class="token number">7</span><span class="token punctuation">;</span>
		dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		SRCLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	rCLK <span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	rCLK <span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			LED_PORT <span class="token operator">=</span> gled_col<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
			<span class="token function">hc595_write_data</span><span class="token punctuation">(</span>gled_row<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">hc595_write_data</span><span class="token punctuation">(</span><span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消影</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="直流电机" tabindex="-1"><a class="header-anchor" href="#直流电机" aria-hidden="true">#</a> 直流电机</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义直流电机控制管脚</span>
sbit DC_Motor<span class="token operator">=</span>P1<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DC_MOTOR_RUN_TIME</span>	<span class="token expression"><span class="token number">5000</span>	</span><span class="token comment">//定义直流电机运行时间为5000ms</span></span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>ms<span class="token punctuation">;</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">;</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	DC_Motor<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//开启电机</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span>DC_MOTOR_RUN_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
	DC_Motor<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//关闭电机</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>			
								
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="步进电机" tabindex="-1"><a class="header-anchor" href="#步进电机" aria-hidden="true">#</a> 步进电机</h2><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义ULN2003控制步进电机管脚</span>
sbit IN1_A<span class="token operator">=</span>P1<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit IN2_B<span class="token operator">=</span>P1<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit IN3_C<span class="token operator">=</span>P1<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit IN4_D<span class="token operator">=</span>P1<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">//定义独立按键控制脚</span>
sbit KEY1<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit KEY2<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit KEY3<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit KEY4<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">//使用宏定义独立按键按下的键值</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_PRESS</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_PRESS</span>	<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY3_PRESS</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY4_PRESS</span>	<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UNPRESS</span>	<span class="token expression"><span class="token number">0</span></span></span>

<span class="token comment">// 定义步进电机速度，值越小，速度越快</span>
<span class="token comment">// 最小不能小于1</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STEPMOTOR_MAXSPEED</span>        <span class="token expression"><span class="token number">1</span>  </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">STEPMOTOR_MINSPEED</span>        <span class="token expression"><span class="token number">5</span>  	</span></span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>ms<span class="token punctuation">;</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">;</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">step_motor_28BYJ48_send_pulse</span><span class="token punctuation">(</span>u8 step<span class="token punctuation">,</span>u8 dir<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 temp<span class="token operator">=</span>step<span class="token punctuation">;</span>
	
	<span class="token keyword">if</span><span class="token punctuation">(</span>dir<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>	<span class="token comment">//如果为逆时针旋转</span>
		temp<span class="token operator">=</span><span class="token number">7</span><span class="token operator">-</span>step<span class="token punctuation">;</span><span class="token comment">//调换节拍信号</span>
	<span class="token keyword">switch</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span><span class="token comment">//8个节拍控制：A-&gt;AB-&gt;B-&gt;BC-&gt;C-&gt;CD-&gt;D-&gt;DA</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token keyword">default</span><span class="token operator">:</span> IN1_A<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN2_B<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN3_C<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>IN4_D<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//停止相序	</span>
	<span class="token punctuation">}</span>			
<span class="token punctuation">}</span>

u8 <span class="token function">key_scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u8 key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//连续扫描按键</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//任意按键按下</span>
	<span class="token punctuation">{</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY1_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY2_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY3_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY4_PRESS<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY2<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY3<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY4<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//无按键按下</span>
	<span class="token punctuation">{</span>
		key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>			
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> KEY_UNPRESS<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 dir<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//默认逆时针方向</span>
	u8 speed<span class="token operator">=</span>STEPMOTOR_MAXSPEED<span class="token punctuation">;</span><span class="token comment">//默认最大速度旋转</span>
	u8 step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>			
		key<span class="token operator">=</span><span class="token function">key_scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY1_PRESS<span class="token punctuation">)</span><span class="token comment">//换向</span>
		<span class="token punctuation">{</span>
			dir<span class="token operator">=</span><span class="token operator">!</span>dir<span class="token punctuation">;</span>    
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY2_PRESS<span class="token punctuation">)</span><span class="token comment">//加速</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>speed<span class="token operator">&gt;</span>STEPMOTOR_MAXSPEED<span class="token punctuation">)</span>
				speed<span class="token operator">-=</span><span class="token number">1</span><span class="token punctuation">;</span>			
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span>KEY3_PRESS<span class="token punctuation">)</span><span class="token comment">//减速</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>speed<span class="token operator">&lt;</span>STEPMOTOR_MINSPEED<span class="token punctuation">)</span>
				speed<span class="token operator">+=</span><span class="token number">1</span><span class="token punctuation">;</span>			
		<span class="token punctuation">}</span>
		<span class="token function">step_motor_28BYJ48_send_pulse</span><span class="token punctuation">(</span>step<span class="token operator">++</span><span class="token punctuation">,</span>dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>step<span class="token operator">==</span><span class="token number">8</span><span class="token punctuation">)</span>step<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		
		<span class="token function">delay_ms</span><span class="token punctuation">(</span>speed<span class="token punctuation">)</span><span class="token punctuation">;</span>						
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="外部中断实验" tabindex="-1"><a class="header-anchor" href="#外部中断实验" aria-hidden="true">#</a> 外部中断实验</h2><p><strong>中断优点：分时操作、实时响应、可靠性高</strong></p><p>中断结构</p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/102504/20/25165/212149/6238289aE55ba7827/4f22a28acf170cb7.png" alt="image-20220320213823253.png"></p><p>中断允许控制</p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/115257/16/26289/32696/623828d0Eb1d2801c/d2a8bf1b2cc6b7f8.png" alt="image-20220320212826772.png"></p><p><code>EA</code>中断总控，<code>ES</code>串口中断</p><p>中断请求标志 <code>TCON</code></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/123690/11/22485/35552/623828e5E9f92bd7d/3b32bc87bd85f7e6.png" alt="image-20220320212904896.png"></p><p>中断优先级</p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/217399/19/15298/88083/623828f5Ed57012a5/f4b1eec323aa0091.png" alt="image-20220320213036855.png"></p><p>中断号</p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/121814/2/25165/162149/62382907E3cf190d3/45187a3e7a526ddd.png" alt="image-20220320213111227.png"></p><p>中断响应条件</p><ol><li><p>中断源有中断请求；</p></li><li><p>中断源的中断允许位为<code> 1</code>；</p></li><li><p>CPU 开中断（即 <code>EA=1</code>）</p></li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义LED1管脚</span>
sbit LED1<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">//定义独立按键K3控制脚</span>
sbit KEY3<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 ten_us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>ten_us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">exti0_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	IT0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//跳变沿触发方式（下降沿）</span>
	EX0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开INT0的中断允许</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开总中断</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token function">exti0_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//外部中断0配置</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>			
							
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
<span class="token comment">//interrupt关键字必须有 0为中断号  using 1默认可省略</span>
<span class="token keyword">void</span> <span class="token function">exti0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">0</span> <span class="token comment">//外部中断0中断函数</span>
<span class="token punctuation">{</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消斗</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//再次判断K3键是否按下</span>
		LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span><span class="token comment">//LED1状态翻转					</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="定时器中断" tabindex="-1"><a class="header-anchor" href="#定时器中断" aria-hidden="true">#</a> 定时器中断</h2><p>（1）振荡周期</p><p>（2）状态周期</p><p>（3）机器周期</p><p>（4）指令周期</p><p>例如：外接晶振为<code> 12MHz</code> 时，51 单片机相关周期的具体值为：</p><p>振荡周期=<code>1/12us</code></p><p>状态周期=<code>1/6us</code></p><p>机器周期=<code>1us</code></p><p>指令周期=<code>1~4us</code></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/210255/19/19597/182028/62382924E42b890a7/5b8d1e222b627413.png" alt="image-20220320215942260.png"></p><p>工作方式寄存器<code>TMOD</code></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/100614/19/26333/38906/6238293cE176ca320/bccde1463432a10d.png" alt="image-20220320220125247.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/134163/21/25439/99066/6238294aEe3fad417/d74e9cf35a310711.png" alt="image-20220320220129968.png"></p><p>控制寄存器<code>TCON</code></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/132961/19/25595/31676/6238295aE485da5a3/daa21150f7dadd04.png" alt="image-20220320220317557.png"></p><p><strong>定时器配置</strong></p><ol><li><p>对 TMOD 赋值，以确定 T0 和 T1 的工作方式</p></li><li><p>根据所要定时的时间计算初值,并将其写入 TH0、TL0 或 TH1、TL1</p></li><li><p>如果使用中断，则对 EA 赋值，开放定时器中断</p></li><li><p>使 TR0 或 TR1 置位，启动定时/计数器定时或计数</p></li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token comment">//定义LED1管脚</span>
sbit LED1<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">time0_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	TMOD<span class="token operator">|=</span><span class="token number">0X01</span><span class="token punctuation">;</span><span class="token comment">//选择为定时器0模式，工作方式1</span>
	TH0<span class="token operator">=</span><span class="token number">0XFC</span><span class="token punctuation">;</span>	<span class="token comment">//给定时器赋初值，定时1ms</span>
	TL0<span class="token operator">=</span><span class="token number">0X66</span><span class="token punctuation">;</span>	 <span class="token comment">//11.0592MHZ 1ms FC66</span>
	ET0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开定时器0中断允许</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开总中断</span>
	TR0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开定时器		</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">time1_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	TMOD<span class="token operator">|=</span> <span class="token number">0x10</span><span class="token punctuation">;</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span>
	TL1 <span class="token operator">=</span> <span class="token number">0x18</span><span class="token punctuation">;</span>
	EA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	ET1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	TR1 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token function">time0_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定时器0中断配置</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>			
							
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">time0</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span> <span class="token comment">//定时器0中断函数</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u16 i<span class="token punctuation">;</span><span class="token comment">//定义静态变量i</span>
	TH0<span class="token operator">=</span><span class="token number">0XFC</span><span class="token punctuation">;</span>	<span class="token comment">//给定时器赋初值，定时1ms</span>
	TL0<span class="token operator">=</span><span class="token number">0X66</span><span class="token punctuation">;</span>
	i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		LED1<span class="token operator">=</span><span class="token operator">!</span>LED1<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>						
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">time1</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">3</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u16 i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	TH1 <span class="token operator">=</span> <span class="token number">0xFC</span><span class="token punctuation">;</span>
	TL1 <span class="token operator">=</span> <span class="token number">0x66</span><span class="token punctuation">;</span>

	i<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">1000</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		LED_1 <span class="token operator">=</span> <span class="token operator">!</span>LED_1<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>			
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="串口通信实验" tabindex="-1"><a class="header-anchor" href="#串口通信实验" aria-hidden="true">#</a> 串口通信实验</h2><p><img src="https://img30.360buyimg.com/pop/jfs/t1/132973/35/25204/38658/6238296cE1716865d/4d26f21dbce8e8fa.png" alt="image-20220320224830628.png"></p><p><strong>交叉连接</strong></p><p><code>RS232</code> 的通信协议比较简单，通常遵循<code>96-N-8-1</code>格式</p><p><code>9600bps</code>-<code>无校验位</code>-<code>8位</code>-<code>1个停止位</code></p><p><strong>串口控制寄存器<code>SCON</code></strong></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/94738/1/25503/29657/6238297bE912d5cad/f8361c0dd764b66c.png" alt="image-20220320225145969.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/118189/11/22842/83519/6238298bEcc923ebe/95f0644e3ea95ec0.png" alt="image-20220320225152348.png"></p><p><strong>电源控制寄存器<code> PCON</code></strong></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/81723/14/16674/27177/6238299cEccb66db7/593b044a11a54931.png" alt="image-20220321115611808.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/93259/40/23963/159182/623829b2Ef81f3e60/4603aad03e10701b.png" alt="image-20220321115640496.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/219124/11/15268/43973/623829fcE21a38066/e99b98c6635d09df.png" alt="image-20220321115700822.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/178031/40/22029/138601/62382a16E8bac6561/6094badde42fe2d1.png" alt="image-20220321115708291.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/138330/39/23699/43056/62382a2fE1a9c9b9b/149982472cf355f1.png" alt="image-20220321115719737.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/115388/36/22219/67030/62382a4aEc0bcbd88/e165476d52019d38.png" alt="image-20220321115726773.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/186289/38/21655/85013/62382a56E21511df5/eca4508be2d9170f.png" alt="image-20220321115731742.png"></p><p><strong>计算波特率</strong></p><p>方式 0 的波特率 = <code>fosc/12 </code></p><p>方式 2 的波特率 =<code>（2SMOD/64）· fosc </code></p><p>方式 1 的波特率 =<code>（2SMOD/32）·（T1 溢出率） </code></p><p>方式 3 的波特率 =<code>（2SMOD/32）·（T1 溢出率） </code></p><p>其中 T1 溢出率 =<code>fosc /{12×[256 －（TH1）]}</code></p><p><strong>串口初始化步骤</strong></p><ol><li><p>确定<code>T1</code> 的工作方式（<code>TMOD</code> 寄存器）；</p></li><li><p>确定串口工作方式（<code>SCON </code>寄存器）；</p></li><li><p>计算<code>T1</code>的初值（设定波特率），装载<code>TH1</code>、<code>TL1</code>；</p></li><li><p>启动<code>T1</code>（<code>TCON</code> 中的<code>TR1</code>位）；</p></li><li><p>如果使用中断，需开启串口中断控制位（<code>IE</code>寄存器）。</p></li></ol><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">uart_init</span><span class="token punctuation">(</span>u8 baud<span class="token punctuation">)</span><span class="token comment">//baud 波特率</span>
<span class="token punctuation">{</span>
	TMOD<span class="token operator">|=</span><span class="token number">0X20</span><span class="token punctuation">;</span>	<span class="token comment">//设置计数器工作方式2</span>
	SCON<span class="token operator">=</span><span class="token number">0X50</span><span class="token punctuation">;</span>	<span class="token comment">//设置为工作方式1</span>
	PCON<span class="token operator">=</span><span class="token number">0X80</span><span class="token punctuation">;</span>	<span class="token comment">//波特率加倍</span>
	TH1<span class="token operator">=</span>baud<span class="token punctuation">;</span>	<span class="token comment">//计数器初始值设置</span>
	TL1<span class="token operator">=</span>baud<span class="token punctuation">;</span>
	ES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//打开接收中断</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//打开总中断</span>
	TR1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		<span class="token comment">//打开计数器		</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token function">uart_init</span><span class="token punctuation">(</span><span class="token number">0XFA</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//波特率为9600</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>			
							
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">uart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">4</span> <span class="token comment">//串口通信中断函数</span>
<span class="token punctuation">{</span>
	u8 rec_data<span class="token punctuation">;</span>

	RI <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//清除接收中断标志位</span>
	rec_data<span class="token operator">=</span>SBUF<span class="token punctuation">;</span>	<span class="token comment">//存储接收到的数据</span>
	SBUF<span class="token operator">=</span>rec_data<span class="token punctuation">;</span>	<span class="token comment">//将接收到的数据放入到发送寄存器</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">!</span>TI<span class="token punctuation">)</span><span class="token punctuation">;</span>		<span class="token comment">//等待发送数据完成</span>
	TI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>			<span class="token comment">//清除发送完成标志位				</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="i2c-eeprom实验" tabindex="-1"><a class="header-anchor" href="#i2c-eeprom实验" aria-hidden="true">#</a> I2C-EEPROM实验</h2><p><strong>应答响应</strong></p><p>应答信号在第9个时钟上出现，接收器输出低电平为<code>ack</code>，输出高电平则为<code>nack</code></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/129748/3/24537/44707/62382a66E29486ef5/0da5c42497b8b36a.png" alt="image-20220321131056728.png"></p><p><strong>总线的寻址方式</strong></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/112795/39/22039/13586/62382a71Ed8f523a0/53e17bfd85579191.png" alt="image-20220321131159308.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/135827/22/24927/40977/62382a7bEd78d57d5/7a8ee232412feade.png" alt="image-20220321131219263.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/99591/35/23823/31589/62382a8bE6140aa18/0f191b4e6cdd1bcc.png" alt="image-20220321131224997.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/86940/30/25601/64704/62382a9bEbbd94082/8ca2af1bb0afa7ad.png" alt="image-20220321131228846.png"></p><p><strong>AT24C02（EEPROM）</strong></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/179422/29/21515/19800/62382aa9Ec563ad8d/a143a731537d7aa5.png" alt="image-20220321131354483.png"></p><p><img src="https://img30.360buyimg.com/pop/jfs/t1/222249/3/13419/45443/62382ab3E98750685/3f001177c8bf9174.png" alt="image-20220321131424671.png"></p><p><strong>文件拓扑结构</strong></p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>.
|--APP
|	|--key.c
|	|--smg.c
|	|--I2C.c
|	|--at24c02.c
|--User
|	|--main.c
|--Public
|	|--public.c
|--OBJ
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;key.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;at24c02.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">EEPROM_ADDRESS</span> <span class="token expression"><span class="token number">0</span></span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 key_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u8 save_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	u8 save_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	key_value <span class="token operator">=</span> <span class="token function">key_scan</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key_value <span class="token operator">==</span> KEY1_PRESS<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">at24c02_write_one_byte</span><span class="token punctuation">(</span>EEPROM_ADDRESS<span class="token punctuation">,</span>save_value<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_value <span class="token operator">==</span> KEY2_PRESS<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		save_value <span class="token operator">=</span> <span class="token function">at24c02_read_one_byte</span><span class="token punctuation">(</span>EEPROM_ADDRESS<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_value <span class="token operator">==</span> KEY3_PRESS<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		save_value<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>save_value<span class="token operator">==</span><span class="token number">255</span><span class="token punctuation">)</span> save_value<span class="token operator">=</span><span class="token number">255</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>key_value <span class="token operator">==</span> KEY4_PRESS<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		save_value <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
    <span class="token comment">//单独取每位</span>
	save_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> save_value<span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">;</span>
	save_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> save_value<span class="token operator">%</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>
	save_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> save_value<span class="token operator">%</span><span class="token number">100</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">;</span>
	<span class="token function">smg_display</span><span class="token punctuation">(</span>save_buf<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//key.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&quot;key.h&quot;</span></span>

u8 <span class="token function">key_scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u8 key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span>key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//连续扫描按键</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>key<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token operator">||</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//任意按键按下  按下为0</span>
	<span class="token punctuation">{</span>
		<span class="token comment">//按键一按下时会产生一连串的抖动</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//消抖</span>
		key<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY1_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY2<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY2_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY3<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY3_PRESS<span class="token punctuation">;</span>
		<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY4<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> KEY4_PRESS<span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>KEY1<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY2<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY3<span class="token operator">==</span><span class="token number">1</span><span class="token operator">&amp;&amp;</span>KEY4<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//无按键按下</span>
	<span class="token punctuation">{</span>
		key<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>			
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> KEY_UNPRESS<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//key.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__KEY_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__KEY_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//定义独立按键控制脚</span>
sbit KEY1<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit KEY2<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
sbit KEY3<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit KEY4<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">//使用宏定义独立按键按下的键值</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY1_PRESS</span>	<span class="token expression"><span class="token number">1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY2_PRESS</span>	<span class="token expression"><span class="token number">2</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY3_PRESS</span>	<span class="token expression"><span class="token number">3</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY4_PRESS</span>	<span class="token expression"><span class="token number">4</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">KEY_UNPRESS</span>	<span class="token expression"><span class="token number">0</span>	</span></span>

u8 <span class="token function">key_scan</span><span class="token punctuation">(</span>u8 mode<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//smg.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&quot;smg.h&quot;</span></span>

u8 gsmg_code<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">{</span><span class="token number">0x3f</span><span class="token punctuation">,</span><span class="token number">0x06</span><span class="token punctuation">,</span><span class="token number">0x5b</span><span class="token punctuation">,</span><span class="token number">0x4f</span><span class="token punctuation">,</span><span class="token number">0x66</span><span class="token punctuation">,</span><span class="token number">0x6d</span><span class="token punctuation">,</span><span class="token number">0x7d</span><span class="token punctuation">,</span><span class="token number">0x07</span><span class="token punctuation">,</span>
				<span class="token number">0x7f</span><span class="token punctuation">,</span><span class="token number">0x6f</span><span class="token punctuation">,</span><span class="token number">0x77</span><span class="token punctuation">,</span><span class="token number">0x7c</span><span class="token punctuation">,</span><span class="token number">0x39</span><span class="token punctuation">,</span><span class="token number">0x5e</span><span class="token punctuation">,</span><span class="token number">0x79</span><span class="token punctuation">,</span><span class="token number">0x71</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">smg_display</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>u8 pos<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 pos_temp <span class="token operator">=</span> pos<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>pos_temp<span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
	   	<span class="token keyword">switch</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token comment">//位选</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">case</span> <span class="token number">0</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//7</span>
			<span class="token keyword">case</span> <span class="token number">1</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//6</span>
			<span class="token keyword">case</span> <span class="token number">2</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//5</span>
			<span class="token keyword">case</span> <span class="token number">3</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//4</span>
			<span class="token keyword">case</span> <span class="token number">4</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//3</span>
			<span class="token keyword">case</span> <span class="token number">5</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//2</span>
			<span class="token keyword">case</span> <span class="token number">6</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//1</span>
			<span class="token keyword">case</span> <span class="token number">7</span><span class="token operator">:</span> LSC<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSB<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>LSA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">break</span><span class="token punctuation">;</span><span class="token comment">//0</span>
		<span class="token punctuation">}</span>
		SMG_A_DP_PORT<span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>dat<span class="token punctuation">[</span>i<span class="token operator">-</span>pos_temp<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//传送段选数据</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时一段时间，等待显示稳定</span>
		SMG_A_DP_PORT<span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span><span class="token comment">//消音</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//smg.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__SMG_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__SMG_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SMG_A_DP_PORT</span>	<span class="token expression">P0	</span><span class="token comment">//使用宏定义数码管段码口</span></span>

<span class="token comment">//定义数码管位选信号控制脚</span>
sbit LSA<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>
sbit LSB<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">3</span><span class="token punctuation">;</span>
sbit LSC<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span>

<span class="token comment">//共阴极数码管显示0~F的段码数据</span>
<span class="token keyword">extern</span> u8 gsmg_code<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">smg_display</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>u8 pos<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//I2C.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&quot;I2C.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">iic_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	IIC_SDA	<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">iic_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	IIC_SDA	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">iic_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SDA	<span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">iic_nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SDA	<span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
u8 <span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 time_temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>IIC_SDA<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		time_temp<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>time_temp<span class="token operator">&gt;</span><span class="token number">100</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token function">iic_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">iic_write_byte</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>dat<span class="token operator">&amp;</span><span class="token number">0x80</span><span class="token punctuation">)</span><span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//判断最高位是否为1</span>
			IIC_SDA <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span>
			IIC_SDA <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		dat<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">//设置时钟周期</span>
		IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
u8 <span class="token function">iic_read_byte</span><span class="token punctuation">(</span>u8 ack<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 receive <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		IIC_SCL <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		IIC_SCL <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		receive<span class="token operator">&lt;&lt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>IIC_SDA<span class="token punctuation">)</span>	receive<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>ack<span class="token punctuation">)</span> <span class="token function">iic_nack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span> <span class="token function">iic_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> receive<span class="token punctuation">;</span> 	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//I2C.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__I2C_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__I2C_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

sbit IIC_SCL <span class="token operator">=</span> P2<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>
sbit IIC_SDA <span class="token operator">=</span> P2<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_stop</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_nack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">iic_write_byte</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8 <span class="token function">iic_read_byte</span><span class="token punctuation">(</span>u8 ack<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//at20c02.c</span>
<span class="token comment">//AT24C02提供2048位的电可擦和可编程只读存储器(EEPROM)</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&quot;at24c02.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&quot;I2C.h&quot;</span></span>
<span class="token keyword">void</span> <span class="token function">at24c02_write_one_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">iic_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span>dat<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
u8  <span class="token function">at24c02_read_one_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 temp <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">iic_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span><span class="token number">0xa0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span>addr<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_write_byte</span><span class="token punctuation">(</span><span class="token number">0xa1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_wait_ack</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	temp <span class="token operator">=</span> <span class="token function">iic_read_byte</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">iic_stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> 	temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//at20c02.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__AT24C02_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__AT24C02_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">at24c02_write_one_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u8 dat<span class="token punctuation">)</span><span class="token punctuation">;</span>
u8  <span class="token function">at24c02_read_one_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//public.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i<span class="token punctuation">,</span>j<span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span>ms<span class="token punctuation">;</span>i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">--</span><span class="token punctuation">)</span>
		<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">110</span><span class="token punctuation">;</span>j<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>
<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 us<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>us<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//public.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">__PUBLIC_H__</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">__PUBLIC_H__</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;reg52.h&quot;</span></span>

<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> u16<span class="token punctuation">;</span>	<span class="token comment">//对系统默认数据类型进行重定义</span>
<span class="token keyword">typedef</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> u8<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">delay_ms</span><span class="token punctuation">(</span>u16 ms<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">delay_10us</span><span class="token punctuation">(</span>u16 us<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="温度传感器ds18b20" tabindex="-1"><a class="header-anchor" href="#温度传感器ds18b20" aria-hidden="true">#</a> 温度传感器DS18B20</h2><p><img src="https://m.360buyimg.com/babel/jfs/t1/168012/19/23177/197087/625a4873Eb66583c8/8a6bda6d0f598739.png" alt="image-20220406202632290.png"></p><h3 id="初始化时序" tabindex="-1"><a class="header-anchor" href="#初始化时序" aria-hidden="true">#</a> 初始化时序</h3><p><img src="https://m.360buyimg.com/babel/jfs/t1/198417/33/22543/72988/625a4892E4e092eb0/aee7248a4f770520.png" alt="image-20220406202702042.png"></p><h3 id="写时序" tabindex="-1"><a class="header-anchor" href="#写时序" aria-hidden="true">#</a> 写时序</h3><p><img src="https://m.360buyimg.com/babel/jfs/t1/119747/26/27779/73671/625a48b8E51dc0c61/45d3a0128bc25093.png" alt="image-20220406204244335.png"></p><h3 id="读时序" tabindex="-1"><a class="header-anchor" href="#读时序" aria-hidden="true">#</a> 读时序</h3><p><img src="https://m.360buyimg.com/babel/jfs/t1/99772/27/25797/76231/625a48d2E4fcc548b/29e148464746732a.png" alt="image-20220406204316468.png"></p><p><strong><code>DS18B20</code> 的典型温度读取过程为：</strong></p><p>复位→发 SKIP ROM 命令（0XCC）→发开始转 换命令（0X44）→延时→复位→发送 SKIP ROM 命令（0XCC）→发读存储器命令 （0XBE）→连续读出两个字节数据(即温度)→结束。</p><div class="language-mermaidjs ext-mermaidjs line-numbers-mode"><pre class="language-mermaidjs"><code>graph TB
A[复位] --&gt; B[发 SKIP ROM 命令] --&gt; C[发开始转 换命令]
C--&gt; D[延时]
D--&gt; E[复位]
E--&gt; F[发送 SKIP ROM 命令]
F--&gt; G[发读存储器命令]
G--&gt; H[读出两个字节数据]
H--&gt; I[结束]

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ds18b20.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ds18b20.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;intrins.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">ds18b20_reset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	DS18B20_PORT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>	<span class="token comment">//拉低DQ</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">75</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//拉低750us</span>
	DS18B20_PORT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//DQ=1</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//20US</span>
<span class="token punctuation">}</span>

u8 <span class="token function">ds18b20_check</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 time_temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span>DS18B20_PORT<span class="token operator">&amp;&amp;</span>time_temp<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">)</span>	<span class="token comment">//等待DQ为低电平</span>
	<span class="token punctuation">{</span>
		time_temp<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>time_temp<span class="token operator">&gt;=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果超时则强制返回1</span>
	<span class="token keyword">else</span> time_temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>DS18B20_PORT<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>time_temp<span class="token operator">&lt;</span><span class="token number">20</span><span class="token punctuation">)</span>	<span class="token comment">//等待DQ为高电平</span>
	<span class="token punctuation">{</span>
		time_temp<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>time_temp<span class="token operator">&gt;=</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果超时则强制返回1</span>
	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

u8 <span class="token function">ds18b20_read_bit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
	DS18B20_PORT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DS18B20_PORT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//该段时间不能过长，必须在15us内读取数据</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>DS18B20_PORT<span class="token punctuation">)</span>dat<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//如果总线上为1则数据dat为1，否则为0</span>
	<span class="token keyword">else</span> dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> dat<span class="token punctuation">;</span>
<span class="token punctuation">}</span> 

u8 <span class="token function">ds18b20_read_byte</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次读取一位，且先读低位再读高位</span>
	<span class="token punctuation">{</span>
		temp<span class="token operator">=</span><span class="token function">ds18b20_read_bit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		dat<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>dat<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//由低位读数据</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> dat<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ds18b20_write_byte</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次写一位，且先写低位再写高位</span>
	<span class="token punctuation">{</span>
		temp<span class="token operator">=</span>dat<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">;</span><span class="token comment">//选择低位准备写入</span>
		dat<span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//将次高位移到低位</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			DS18B20_PORT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			DS18B20_PORT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			DS18B20_PORT<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			DS18B20_PORT<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
			<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ds18b20_start</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">ds18b20_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位</span>
	<span class="token function">ds18b20_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//检查DS18B20</span>
	<span class="token function">ds18b20_write_byte</span><span class="token punctuation">(</span><span class="token number">0xcc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SKIP ROM</span>
    <span class="token function">ds18b20_write_byte</span><span class="token punctuation">(</span><span class="token number">0x44</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//转换命令	</span>
<span class="token punctuation">}</span>

u8 <span class="token function">ds18b20_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">ds18b20_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token function">ds18b20_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">float</span> <span class="token function">ds18b20_read_temperture</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">float</span> temp<span class="token punctuation">;</span>
	u8 dath<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 datl<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">ds18b20_start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//开始转换</span>
	<span class="token function">ds18b20_reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//复位</span>
	<span class="token function">ds18b20_check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ds18b20_write_byte</span><span class="token punctuation">(</span><span class="token number">0xcc</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//SKIP ROM</span>
    <span class="token function">ds18b20_write_byte</span><span class="token punctuation">(</span><span class="token number">0xbe</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//读存储器</span>

	datl<span class="token operator">=</span><span class="token function">ds18b20_read_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//低字节</span>
	dath<span class="token operator">=</span><span class="token function">ds18b20_read_byte</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//高字节</span>
	value<span class="token operator">=</span><span class="token punctuation">(</span>dath<span class="token operator">&lt;&lt;</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token operator">+</span>datl<span class="token punctuation">;</span><span class="token comment">//合并为16位数据</span>
	<span class="token comment">//value=(dath&lt;&lt;8)|datl;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>value<span class="token operator">&amp;</span><span class="token number">0xf800</span><span class="token punctuation">)</span><span class="token operator">==</span><span class="token number">0xf800</span><span class="token punctuation">)</span><span class="token comment">//判断符号位，负温度</span>
	<span class="token punctuation">{</span>
		value<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">~</span>value<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//数据取反再加1</span>
        <span class="token comment">//value=(~value)|1;</span>
		temp<span class="token operator">=</span>value<span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">0.0625</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//乘以精度	</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span> <span class="token comment">//正温度</span>
	<span class="token punctuation">{</span>
		temp<span class="token operator">=</span>value<span class="token operator">*</span><span class="token number">0.0625</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> temp<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ds18b20.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_ds18b20_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_ds18b20_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//管脚定义</span>
sbit DS18B20_PORT<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">7</span><span class="token punctuation">;</span>	<span class="token comment">//DS18B20数据口定义</span>


<span class="token comment">//函数声明</span>
u8 <span class="token function">ds18b20_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">float</span> <span class="token function">ds18b20_read_temperture</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ds18b20.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   	<span class="token keyword">int</span> temp_value<span class="token punctuation">;</span>
	u8 temp_buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">ds18b20_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化DS18B20</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>				
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">50</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//间隔一段时间读取温度值，间隔时间要大于温度传感器转换温度时间</span>
			temp_value<span class="token operator">=</span><span class="token function">ds18b20_read_temperture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//保留温度值小数后一位</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp_value<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//负温度</span>
		<span class="token punctuation">{</span>
			temp_value<span class="token operator">=</span><span class="token operator">-</span>temp_value<span class="token punctuation">;</span>
			temp_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">;</span><span class="token comment">//显示负号	</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
			temp_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span><span class="token comment">//不显示</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//百位</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//十位</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">|</span><span class="token number">0x80</span><span class="token punctuation">;</span><span class="token comment">//个位+小数点</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//小数点后一位</span>
		<span class="token function">smg_display</span><span class="token punctuation">(</span>temp_buf<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="时钟芯片ds1302" tabindex="-1"><a class="header-anchor" href="#时钟芯片ds1302" aria-hidden="true">#</a> 时钟芯片DS1302</h2><p><strong>控制寄存器</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/145551/26/26891/25748/625a48faE03483092/e09730b285b61179.png" alt="image-20220411203922558.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/152583/25/21383/177583/625a490dE82a9c362/dba572372ad5bdfb.png" alt="image-20220411204006216.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/123867/14/20595/178066/625a4922Eb96dc1d7/bcfe81a502010562.png" alt="image-20220411204011131.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/104490/13/26994/176769/625a4935E5758760c/ec3c7a35d46a216d.png" alt="image-20220411204628083.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/202950/27/21669/160700/625a494dEb5683074/31aba0e5087ac301.png" alt="image-20220411204633613.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/212032/26/17447/107548/625a495fE97e7353f/5aebc3946b1e4242.png" alt="image-20220412123156760.png"></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ds1302.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ds1302.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;intrins.h&quot;</span></span>

<span class="token comment">//---DS1302写入和读取时分秒的地址命令---//</span>
<span class="token comment">//---秒分时日月周年 最低位读写位;-------//</span>
u8 gREAD_RTC_ADDR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x81</span><span class="token punctuation">,</span> <span class="token number">0x83</span><span class="token punctuation">,</span> <span class="token number">0x85</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0x89</span><span class="token punctuation">,</span> <span class="token number">0x8b</span><span class="token punctuation">,</span> <span class="token number">0x8d</span><span class="token punctuation">}</span><span class="token punctuation">;</span> 
u8 gWRITE_RTC_ADDR<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x80</span><span class="token punctuation">,</span> <span class="token number">0x82</span><span class="token punctuation">,</span> <span class="token number">0x84</span><span class="token punctuation">,</span> <span class="token number">0x86</span><span class="token punctuation">,</span> <span class="token number">0x88</span><span class="token punctuation">,</span> <span class="token number">0x8a</span><span class="token punctuation">,</span> <span class="token number">0x8c</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">//---DS1302时钟初始化2021年5月20日星期四13点51分47秒。---//</span>
<span class="token comment">//---存储顺序是秒分时日月周年,存储格式是用BCD码---//</span>
u8 gDS1302_TIME<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x13</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x04</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x21</span><span class="token punctuation">}</span><span class="token punctuation">;</span>


<span class="token keyword">void</span> <span class="token function">ds1302_write_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">,</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	
	DS1302_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//CLK低电平</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DS1302_RST<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//RST由低到高变化</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次写1位，先写低位再写高位</span>
	<span class="token punctuation">{</span>
		DS1302_IO<span class="token operator">=</span>addr<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">;</span>
		addr<span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//CLK由低到高产生一个上升沿，从而写入数据</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次写1位，先写低位再写高位</span>
	<span class="token punctuation">{</span>
		DS1302_IO<span class="token operator">=</span>dat<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">;</span>
		dat<span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	DS1302_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//RST拉低</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

u8 <span class="token function">ds1302_read_byte</span><span class="token punctuation">(</span>u8 addr<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 temp<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	DS1302_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//CLK低电平</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DS1302_RST<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//RST由低到高变化</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次写1位，先写低位再写高位</span>
	<span class="token punctuation">{</span>
		DS1302_IO<span class="token operator">=</span>addr<span class="token operator">&amp;</span><span class="token number">0x01</span><span class="token punctuation">;</span>
		addr<span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span>	
		DS1302_CLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//CLK由低到高产生一个上升沿，从而写入数据</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次读1位，先读低位再读高位</span>
	<span class="token punctuation">{</span>
		temp<span class="token operator">=</span>DS1302_IO<span class="token punctuation">;</span>
		value<span class="token operator">=</span><span class="token punctuation">(</span>temp<span class="token operator">&lt;&lt;</span><span class="token number">7</span><span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span>value<span class="token operator">&gt;&gt;</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//先将value右移1位，然后temp左移7位，最后或运算</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		DS1302_CLK<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>
	DS1302_RST<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//RST拉低</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	DS1302_CLK<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//对于实物中，P3.4口没有外接上拉电阻的，此处代码需要添加，使数据口有一个上升沿脉冲。</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DS1302_IO <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	DS1302_IO <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token keyword">return</span> value<span class="token punctuation">;</span>		
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ds1302_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">ds1302_write_byte</span><span class="token punctuation">(</span><span class="token number">0x8E</span><span class="token punctuation">,</span><span class="token number">0X00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token function">ds1302_write_byte</span><span class="token punctuation">(</span>gWRITE_RTC_ADDR<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">,</span>gDS1302_TIME<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token function">ds1302_write_byte</span><span class="token punctuation">(</span><span class="token number">0x8E</span><span class="token punctuation">,</span><span class="token number">0X80</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ds1302_read_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">7</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		gDS1302_TIME<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token function">ds1302_read_byte</span><span class="token punctuation">(</span>gREAD_RTC_ADDR<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ds1302.H</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_ds1302_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_ds1302_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//管脚定义</span>
sbit DS1302_RST<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//复位管脚</span>
sbit DS1302_CLK<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//时钟管脚</span>
sbit DS1302_IO<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//数据管脚</span>

<span class="token comment">//变量声明</span>
<span class="token keyword">extern</span> u8 gDS1302_TIME<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存储时间</span>

<span class="token comment">//函数声明</span>
<span class="token keyword">void</span> <span class="token function">ds1302_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">ds1302_read_time</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ds1302.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 time_buf<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	
	<span class="token function">ds1302_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化DS1302</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>				
		<span class="token function">ds1302_read_time</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		time_buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gDS1302_TIME<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&amp;</span><span class="token number">0x0f</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
		<span class="token function">smg_display</span><span class="token punctuation">(</span>time_buf<span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="红外遥控" tabindex="-1"><a class="header-anchor" href="#红外遥控" aria-hidden="true">#</a> 红外遥控</h2><p><code>NEC </code>码的位定义：一个脉冲对应<code>560us</code>的连续载波，一个逻辑 <code>1</code> 传输需要 <code>2.25ms</code>（<code>560us </code>脉冲+<code>1680us </code>低电平），一个逻辑<code>0</code>的传输需要<code> 1.125ms</code>（<code>560us</code> 脉冲+<code>560us</code> 低电平）</p><p><img src="https://m.360buyimg.com/babel/jfs/t1/179027/7/22773/33416/625a497aE652934f6/4ae4754751f05e12.png" alt="image-20220412162538592.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/104668/11/27524/78077/625a497eE784bb8c9/4f411157b3c4bed2.png" alt="image-20220412162652869.png"></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ired.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ired.h&quot;</span></span>

u8 gired_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//存储4个字节接收码（地址码+地址反码+控制码+控制反码）</span>

<span class="token keyword">void</span> <span class="token function">ired_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	IT0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//下降沿触发</span>
	EX0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//打开中断0允许</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//打开总中断</span>
	IRED<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>	<span class="token comment">//初始化端口</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">ired</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">0</span>	<span class="token comment">//外部中断0服务函数</span>
<span class="token punctuation">{</span>
	u8 ired_high_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u16 time_cnt<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">,</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>IRED<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		time_cnt<span class="token operator">=</span><span class="token number">1000</span><span class="token punctuation">;</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token operator">!</span>IRED<span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span><span class="token punctuation">(</span>time_cnt<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token comment">//等待引导信号9ms低电平结束，若超过10ms强制退出</span>
		<span class="token punctuation">{</span>
			<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时约10us</span>
			time_cnt<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>time_cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>		
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>IRED<span class="token punctuation">)</span><span class="token comment">//引导信号9ms低电平已过，进入4.5ms高电平</span>
		<span class="token punctuation">{</span>
			time_cnt<span class="token operator">=</span><span class="token number">500</span><span class="token punctuation">;</span>
			<span class="token keyword">while</span><span class="token punctuation">(</span>IRED<span class="token operator">&amp;&amp;</span>time_cnt<span class="token punctuation">)</span><span class="token comment">//等待引导信号4.5ms高电平结束，若超过5ms强制退出</span>
			<span class="token punctuation">{</span>
				<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				time_cnt<span class="token operator">--</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span><span class="token punctuation">(</span>time_cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>	
			<span class="token punctuation">}</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环4次，读取4个字节数据</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">for</span><span class="token punctuation">(</span>j<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>j<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>j<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次读取每位数据即一个字节</span>
				<span class="token punctuation">{</span>
					time_cnt<span class="token operator">=</span><span class="token number">600</span><span class="token punctuation">;</span>
					<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>IRED<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token operator">&amp;&amp;</span>time_cnt<span class="token punctuation">)</span><span class="token comment">//等待数据1或0前面的0.56ms结束，若超过6ms强制退出</span>
					<span class="token punctuation">{</span>
						<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						time_cnt<span class="token operator">--</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span>time_cnt<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>	
					<span class="token punctuation">}</span>
					time_cnt<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
					<span class="token keyword">while</span><span class="token punctuation">(</span>IRED<span class="token punctuation">)</span><span class="token comment">//等待数据1或0后面的高电平结束，若超过2ms强制退出</span>
					<span class="token punctuation">{</span>
						<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//约0.1ms</span>
						ired_high_time<span class="token operator">++</span><span class="token punctuation">;</span>
						<span class="token keyword">if</span><span class="token punctuation">(</span>ired_high_time<span class="token operator">&gt;</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span>	
					<span class="token punctuation">}</span>
					gired_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">&gt;&gt;=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//先读取的为低位，然后是高位</span>
					<span class="token keyword">if</span><span class="token punctuation">(</span>ired_high_time<span class="token operator">&gt;=</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token comment">//如果高电平时间大于0.8ms，数据则为1，否则为0</span>
						gired_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">|=</span><span class="token number">0x80</span><span class="token punctuation">;</span>
					ired_high_time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//重新清零，等待下一次计算时间</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>gired_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token operator">~</span>gired_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token comment">//校验控制码与反码，错误则返回</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">4</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span>
				gired_data<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//ired.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_ired_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_ired_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//管脚定义</span>
sbit IRED<span class="token operator">=</span>P3<span class="token operator">^</span><span class="token number">2</span><span class="token punctuation">;</span>

<span class="token comment">//声明变量</span>
<span class="token keyword">extern</span> u8 gired_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>


<span class="token comment">//函数声明</span>
<span class="token keyword">void</span> <span class="token function">ired_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ired.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 ired_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token function">ired_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//红外初始化</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>				
		ired_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gired_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">/</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//将控制码高4位转换为数码管段码</span>
		ired_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>gired_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">%</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//将控制码低4位转换为数码管段码</span>
		ired_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0X76</span><span class="token punctuation">;</span><span class="token comment">//显示H的段码</span>
		<span class="token function">smg_display</span><span class="token punctuation">(</span>ired_buf<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="adc模数转换" tabindex="-1"><a class="header-anchor" href="#adc模数转换" aria-hidden="true">#</a> ADC模数转换</h2><p>AD 转换器（ADC）将模拟量转换为数字量通常要经过 4 个步骤：采样、保持、量化和编码。</p><p>将采样电平（模拟值）转换为数字值时，主要有两类方法：直接比较型与间接比较型。</p><p><strong>逐次逼近型ADC</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/149886/10/26608/95228/625a497bEbd41d3d3/7432a3a62ce74376.png" alt="image-20220413231143808.png"></p><p><strong>双积分型ADC</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/96350/2/26828/114899/625a497dE403c5557/7366736049b0a4ff.png" alt="image-20220413231157934.png"></p><p><code>XPT2046 </code>是一款 4 线制电阻式触摸屏控制器，内含 12 位分辨率<code>125KHz</code>转换速率逐步逼近型 <code>A/D </code>转换器。</p><p><img src="https://m.360buyimg.com/babel/jfs/t1/133668/10/20897/85331/625a497cE069b8343/5f2c3a798735348f.png" alt="image-20220413231933813.png"></p><p><strong>主要特性</strong></p><ul><li><p>①工作电压范围为 1.5V～5.25V</p></li><li><p>②支持 1.5V～5.25V 的数字 I/O 口</p></li><li><p>③内建 2.5V 参考电压源</p></li><li><p>④电源电压测量（ 0V~6V）</p></li><li><p>⑤内建结温测量功能</p></li><li><p>⑥触摸压力测量</p></li><li><p>⑦采用 3 线制 SPI 通信接口</p></li><li><p>⑧具有自动省电功能</p></li></ul><p><img src="https://m.360buyimg.com/babel/jfs/t1/195282/27/23175/249776/625a49cdEa42fdc3a/eab387792f724d17.png" alt="image-20220413232008889.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/144207/37/25921/111497/625a49cbE869a7191/d288f807b8dd6dfb.png" alt="image-20220413232013642.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/209462/21/20422/35432/625a49cbE582256aa/b5cdf9df4df3a5f7.png" alt="image-20220413232017245.png"></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//xpt2046.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;xpt2046.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;intrins.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">xpt2046_wirte_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token punctuation">;</span>

	CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">8</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环8次，每次传输一位，共一个字节</span>
	<span class="token punctuation">{</span>
		DIN <span class="token operator">=</span> dat <span class="token operator">&gt;&gt;</span> <span class="token number">7</span><span class="token punctuation">;</span><span class="token comment">//先传高位再传低位</span>
		dat <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//将低位移到高位</span>
		CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//CLK由低到高产生一个上升沿，从而写入数据</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
		CLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

u16	<span class="token function">xpt2046_read_data</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token punctuation">;</span>
	u16 dat<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span><span class="token number">12</span><span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span><span class="token comment">//循环12次，每次读取一位，大于一个字节数，所以返回值类型是u16</span>
	<span class="token punctuation">{</span>
		dat <span class="token operator">&lt;&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		CLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//CLK由高到低产生一个下降沿，从而读取数据</span>
		<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		dat <span class="token operator">|=</span> DOUT<span class="token punctuation">;</span><span class="token comment">//先读取高位，再读取低位。	</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> dat<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

u16 <span class="token function">xpt2046_read_adc_value</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token punctuation">;</span>
	u16 adc_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//先拉低时钟</span>
	CS  <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能XPT2046</span>
	<span class="token function">xpt2046_wirte_data</span><span class="token punctuation">(</span>cmd<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//发送命令字</span>
	<span class="token keyword">for</span><span class="token punctuation">(</span>i<span class="token operator">=</span><span class="token number">6</span><span class="token punctuation">;</span> i<span class="token operator">&gt;</span><span class="token number">0</span><span class="token punctuation">;</span> i<span class="token operator">--</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//延时等待转换结果</span>
	CLK <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	CLK <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//发送一个时钟，清除BUSY</span>
	<span class="token function">_nop_</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	adc_value<span class="token operator">=</span><span class="token function">xpt2046_read_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	CS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//关闭XPT2046</span>
	<span class="token keyword">return</span> adc_value<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//xpt2046.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_xpt2046_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_xpt2046_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//管脚定义</span>
sbit DOUT <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">7</span><span class="token punctuation">;</span>	  <span class="token comment">//输出</span>
sbit CLK  <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span>	  <span class="token comment">//时钟</span>
sbit DIN  <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">4</span><span class="token punctuation">;</span>	  <span class="token comment">//输入</span>
sbit CS   <span class="token operator">=</span> P3<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span>	  <span class="token comment">//片选</span>


<span class="token comment">//函数声明</span>
u16 <span class="token function">xpt2046_read_adc_value</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;xpt2046.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u16 adc_value<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">float</span> adc_vol<span class="token punctuation">;</span><span class="token comment">//ADC电压值</span>
	u8 adc_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>				
		adc_value<span class="token operator">=</span><span class="token function">xpt2046_read_adc_value</span><span class="token punctuation">(</span><span class="token number">0x94</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//测量电位器</span>
		adc_vol<span class="token operator">=</span><span class="token number">5.0</span><span class="token operator">*</span>adc_value<span class="token operator">/</span><span class="token number">4096</span><span class="token punctuation">;</span><span class="token comment">//将读取的AD值转换为电压</span>
		adc_value<span class="token operator">=</span>adc_vol<span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//放大10倍，即保留小数点后一位</span>
		adc_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>adc_value<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">|</span><span class="token number">0x80</span><span class="token punctuation">;</span>
		adc_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>adc_value<span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	   	adc_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x3e</span><span class="token punctuation">;</span><span class="token comment">//显示单位V</span>
		<span class="token function">smg_display</span><span class="token punctuation">(</span>adc_buf<span class="token punctuation">,</span><span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">;</span>		
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="dac数模转换" tabindex="-1"><a class="header-anchor" href="#dac数模转换" aria-hidden="true">#</a> DAC数模转换</h2><p><strong>DAC工作原理</strong></p><p>DAC 输出电压计算公式：</p><p class="katex-block"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>V</mi><mn>0</mn></msub><mo>=</mo><mfrac><mrow><msub><mi>V</mi><mrow><mi>r</mi><mi>e</mi><mi>f</mi></mrow></msub><mo>×</mo><mi>z</mi></mrow><mn>256</mn></mfrac></mrow><annotation encoding="application/x-tex">V_0=\frac{V_{ref}\times z}{256} </annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:2.0463em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">256</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">re</span><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">×</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/192044/12/23207/421628/625a49d1Edd19a7b6/2add151d708326e3.png" alt="image-20220414165154610.png"></p><p><strong>PWM</strong> <code>是 </code>Pulse Width Modulation <code>的缩写，中文意思就是</code>脉冲宽度调制<code>，简称</code>脉宽调制`。</p><p><img src="https://m.360buyimg.com/babel/jfs/t1/99240/12/25844/54397/625a49cdE8f298af9/8ccb627744266d6d.png" alt="image-20220414165344036.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/128199/33/20891/19250/625a49caE5eaffa50/16b0acffe8d2c7b4.png" alt="image-20220414165350099.png"></p><p>通过调节占空比输出调制脉宽</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//pwm.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pwm.h&quot;</span></span>

<span class="token comment">//全局变量定义</span>
u8 gtim_h<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存定时器初值高8位</span>
u8 gtim_l<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存定时器初值低8位</span>
u8 gduty<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存PWM占空比</span>
u8 gtim_scale<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//保存PWM周期=定时器初值*tim_scale</span>

<span class="token keyword">void</span> <span class="token function">pwm_init</span><span class="token punctuation">(</span>u8 tim_h<span class="token punctuation">,</span>u8 tim_l<span class="token punctuation">,</span>u16 tim_scale<span class="token punctuation">,</span>u8 duty<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	gtim_h<span class="token operator">=</span>tim_h<span class="token punctuation">;</span><span class="token comment">//将传入的初值保存在全局变量中，方便中断函数继续调用</span>
	gtim_l<span class="token operator">=</span>tim_l<span class="token punctuation">;</span>
	gduty<span class="token operator">=</span>duty<span class="token punctuation">;</span>
	gtim_scale<span class="token operator">=</span>tim_scale<span class="token punctuation">;</span>

	TMOD<span class="token operator">|=</span><span class="token number">0X01</span><span class="token punctuation">;</span>	<span class="token comment">//选择为定时器0模式，工作方式1</span>
	TH0 <span class="token operator">=</span> gtim_h<span class="token punctuation">;</span>	<span class="token comment">//定时初值设置 </span>
	TL0 <span class="token operator">=</span> gtim_l<span class="token punctuation">;</span>		
	ET0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开定时器0中断允许</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开总中断</span>
	TR0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//打开定时器</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pwm_set_duty_cycle</span><span class="token punctuation">(</span>u8 duty<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	gduty<span class="token operator">=</span>duty<span class="token punctuation">;</span>	
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">pwm</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> interrupt <span class="token number">1</span>	<span class="token comment">//定时器0中断函数</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u16 time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	TH0 <span class="token operator">=</span> gtim_h<span class="token punctuation">;</span>	<span class="token comment">//定时初值设置 </span>
	TL0 <span class="token operator">=</span> gtim_l<span class="token punctuation">;</span>
	
	time<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">&gt;=</span>gtim_scale<span class="token punctuation">)</span><span class="token comment">//PWM周期=定时器初值*gtim_scale，重新开始计数</span>
		time<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>time<span class="token operator">&lt;=</span>gduty<span class="token punctuation">)</span><span class="token comment">//占空比	</span>
		PWM<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token keyword">else</span>
		PWM<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//pwm.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_pwm_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_pwm_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>


<span class="token comment">//管脚定义</span>
sbit PWM<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">//变量声明</span>
<span class="token keyword">extern</span> u8 gtim_scale<span class="token punctuation">;</span>

<span class="token comment">//函数声明</span>
<span class="token keyword">void</span> <span class="token function">pwm_init</span><span class="token punctuation">(</span>u8 tim_h<span class="token punctuation">,</span>u8 tim_l<span class="token punctuation">,</span>u16 tim_scale<span class="token punctuation">,</span>u8 duty<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">pwm_set_duty_cycle</span><span class="token punctuation">(</span>u8 duty<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;pwm.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	u8 dir<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//默认为0</span>
	u8 duty<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token function">pwm_init</span><span class="token punctuation">(</span><span class="token number">0XFF</span><span class="token punctuation">,</span><span class="token number">0XF6</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//定时时间为0.01ms，PWM周期是100*0.01ms=1ms，占空比为0%</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>dir<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//当dir为递增方向</span>
		<span class="token punctuation">{</span>
			duty<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//占空比递增</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>duty<span class="token operator">==</span><span class="token number">70</span><span class="token punctuation">)</span>dir<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//当到达一定值切换方向，占空比最大能到100，但到达70左右再递增，</span>
								<span class="token comment">//肉眼也分辨不出亮度变化	</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			duty<span class="token operator">--</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>duty<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>dir<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//当到达一定值切换方向	</span>
		<span class="token punctuation">}</span>
		<span class="token function">pwm_set_duty_cycle</span><span class="token punctuation">(</span>duty<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置占空比</span>
		<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//短暂延时，让呼吸灯有一个流畅的效果			</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="lcd1602" tabindex="-1"><a class="header-anchor" href="#lcd1602" aria-hidden="true">#</a> LCD1602</h2><p><img src="https://m.360buyimg.com/babel/jfs/t1/99786/37/28369/63777/625a4a24E6fcb18fd/8356f3e2f496eb9f.png" alt="image-20220414184305813.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/222251/22/15694/78099/625a4a2eE5303c017/bf86b83dff8744d1.png" alt="image-20220414184317184.png"></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/216582/13/17625/43050/625a4a35Ea8d9497c/c1fd9eed50443ee2.png" alt="image-20220414184321461.png"></p><p><strong>清屏指令</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/181409/11/23572/39445/625a4a26E6baab9b8/30b7249165b27caf.png" alt="image-20220414184342167.png"></p><p><strong>模式设置指令</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/130945/12/26883/41813/625a4a29E1c9a2a73/0c2a9e6481da62e1.png" alt="image-20220414184352766.png"></p><p><strong>显示开关控制指令</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/223916/1/9795/49334/625a4a2cE3d3e110c/a29fe9479851a5c1.png" alt="image-20220414184406286.png"></p><p><strong>功能设定指令</strong></p><p><img src="https://m.360buyimg.com/babel/jfs/t1/223627/6/9855/47810/625a4a31E930340f8/c7b58577c3f70ff2.png" alt="image-20220414184417864.png"></p><ol><li>初始化</li><li>写命令（RS=L），设置显示坐标</li><li>写数据（RS=H）</li></ol><p><img src="https://m.360buyimg.com/babel/jfs/t1/92195/19/26485/39958/625a4a33Ea4de70b7/03e172494853bc5f.png" alt="image-20220414185622918.png"></p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//lcd1602.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lcd1602.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LCD1602_4OR8_DATA_INTERFACE<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></span><span class="token comment">//8位LCD</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	LCD1602_RS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择命令</span>
	LCD1602_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择写</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LCD1602_DATAPORT<span class="token operator">=</span>cmd<span class="token punctuation">;</span><span class="token comment">//准备命令</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入	</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span>	<span class="token comment">//4位LCD</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span>u8 cmd<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	LCD1602_RS<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择命令</span>
	LCD1602_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择写</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LCD1602_DATAPORT<span class="token operator">=</span>cmd<span class="token punctuation">;</span><span class="token comment">//准备命令</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入</span>
	
	LCD1602_DATAPORT<span class="token operator">=</span>cmd<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//准备命令</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入	</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LCD1602_4OR8_DATA_INTERFACE<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></span><span class="token comment">//8位LCD</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	LCD1602_RS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//选择数据</span>
	LCD1602_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择写</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LCD1602_DATAPORT<span class="token operator">=</span>dat<span class="token punctuation">;</span><span class="token comment">//准备数据</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入		</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_write_data</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	LCD1602_RS<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//选择数据</span>
	LCD1602_RW<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//选择写</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
	LCD1602_DATAPORT<span class="token operator">=</span>dat<span class="token punctuation">;</span><span class="token comment">//准备数据</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入</span>
	
	LCD1602_DATAPORT<span class="token operator">=</span>dat<span class="token operator">&lt;&lt;</span><span class="token number">4</span><span class="token punctuation">;</span><span class="token comment">//准备数据</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//使能脚E先上升沿写入</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	LCD1602_E<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//使能脚E后负跳变完成写入		</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression"><span class="token punctuation">(</span>LCD1602_4OR8_DATA_INTERFACE<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span></span><span class="token comment">//8位LCD</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x38</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数据总线8位，显示2行，5*7点阵/字符</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x0c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示功能开，无光标，光标闪烁</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入新数据后光标右移，显示屏不移动</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清屏	</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span>
<span class="token keyword">void</span> <span class="token function">lcd1602_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//数据总线4位，显示2行，5*7点阵/字符</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x0c</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示功能开，无光标，光标闪烁</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x06</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//写入新数据后光标右移，显示屏不移动</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//清屏	</span>
<span class="token punctuation">}</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

<span class="token keyword">void</span> <span class="token function">lcd1602_clear</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
<span class="token punctuation">}</span>


<span class="token keyword">void</span> <span class="token function">lcd1602_show_string</span><span class="token punctuation">(</span>u8 x<span class="token punctuation">,</span>u8 y<span class="token punctuation">,</span>u8 <span class="token operator">*</span>str<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&gt;</span><span class="token number">1</span><span class="token operator">||</span>x<span class="token operator">&gt;</span><span class="token number">15</span><span class="token punctuation">)</span><span class="token keyword">return</span><span class="token punctuation">;</span><span class="token comment">//行列参数不对则强制退出</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>y<span class="token operator">&lt;</span><span class="token number">1</span><span class="token punctuation">)</span>	<span class="token comment">//第1行显示</span>
	<span class="token punctuation">{</span>	
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token operator">!=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span><span class="token comment">//字符串是以&#39;\0&#39;结尾，只要前面有内容就显示</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">-</span>x<span class="token punctuation">)</span><span class="token comment">//如果字符长度超过第一行显示范围，则在第二行继续显示</span>
			<span class="token punctuation">{</span>
				<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">+</span>i<span class="token operator">+</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第一行显示地址设置	</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x40</span><span class="token operator">+</span><span class="token number">0x80</span><span class="token operator">+</span>i<span class="token operator">+</span>x<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第二行显示地址设置	</span>
			<span class="token punctuation">}</span>
			<span class="token function">lcd1602_write_data</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//显示内容</span>
			str<span class="token operator">++</span><span class="token punctuation">;</span><span class="token comment">//指针递增</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>
	<span class="token keyword">else</span>	<span class="token comment">//第2行显示</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token operator">!=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">&lt;</span><span class="token number">16</span><span class="token operator">-</span>x<span class="token punctuation">)</span> <span class="token comment">//如果字符长度超过第二行显示范围，则在第一行继续显示</span>
			<span class="token punctuation">{</span>
				<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">+</span><span class="token number">0x40</span><span class="token operator">+</span>i<span class="token operator">+</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token punctuation">}</span>
			<span class="token keyword">else</span>
			<span class="token punctuation">{</span>
				<span class="token function">lcd1602_write_cmd</span><span class="token punctuation">(</span><span class="token number">0x80</span><span class="token operator">+</span>i<span class="token operator">+</span>x<span class="token operator">-</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
			<span class="token punctuation">}</span>
			<span class="token function">lcd1602_write_data</span><span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>
			str<span class="token operator">++</span><span class="token punctuation">;</span>
			i<span class="token operator">++</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>	
	<span class="token punctuation">}</span>				
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//lcd1602.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_lcd1602_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_lcd1602_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>

<span class="token comment">//LCD1602数据口4位和8位定义，若为1，则为LCD1602四位数据口驱动，反之为8位</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD1602_4OR8_DATA_INTERFACE</span>	<span class="token expression"><span class="token number">0</span>	</span><span class="token comment">//默认使用8位数据口LCD1602</span></span>

<span class="token comment">//管脚定义</span>
sbit LCD1602_RS<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">6</span><span class="token punctuation">;</span><span class="token comment">//数据命令选择</span>
sbit LCD1602_RW<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">5</span><span class="token punctuation">;</span><span class="token comment">//读写选择</span>
sbit LCD1602_E<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">7</span><span class="token punctuation">;</span> <span class="token comment">//使能信号</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LCD1602_DATAPORT</span> <span class="token expression">P0	</span><span class="token comment">//宏定义LCD1602数据端口</span></span>


<span class="token comment">//函数声明</span>
<span class="token keyword">void</span> <span class="token function">lcd1602_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lcd1602_clear</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">lcd1602_show_string</span><span class="token punctuation">(</span>u8 x<span class="token punctuation">,</span>u8 y<span class="token punctuation">,</span>u8 <span class="token operator">*</span>str<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;lcd1602.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token function">lcd1602_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//LCD1602初始化</span>
	<span class="token function">lcd1602_show_string</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token string">&quot;Hello World!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第一行显示</span>
	<span class="token function">lcd1602_show_string</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token string">&quot;0123456789&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//第二行显示</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="esp8266" tabindex="-1"><a class="header-anchor" href="#esp8266" aria-hidden="true">#</a> ESP8266</h2><p><strong>AP</strong>是<code>(Wireless)AccessPoint</code>的简称，接入点。</p><p>该芯片用到了<code>AT指令集</code></p><p>指令集主要分为：基础 AT 命令、Wifi 功能 AT 命令、TCP/IP 工具箱 AT 命 令等。</p><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//wifi_control.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;wifi_control.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;ds18b20.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;uart.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;smg.h&quot;</span></span>

<span class="token comment">//定义LED1管脚</span>
sbit LED1<span class="token operator">=</span>P2<span class="token operator">^</span><span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">//定义WIFI控制命令</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED1_ON_CMD</span>			<span class="token char">&#39;1&#39;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">LED1_OFF_CMD</span>		<span class="token char">&#39;2&#39;</span></span>


<span class="token comment">//ESP8266 WIFI发送AT指令</span>
<span class="token comment">//pbuf：AT指令，字符串格式，如：&quot;AT&quot;</span>
<span class="token keyword">void</span> <span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pbuf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">!=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span> <span class="token comment">//遇到空格跳出循环	</span>
	<span class="token punctuation">{</span>
		<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pbuf<span class="token operator">++</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token char">&#39;\r&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//回车</span>
	<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token char">&#39;\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//换行</span>
	<span class="token function">delay_ms</span><span class="token punctuation">(</span><span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">//ESP8266 WIFI发送数据到APP</span>
<span class="token comment">//pbuf：数据</span>
<span class="token keyword">void</span> <span class="token function">ESP8266_SendData</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pbuf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CIPSEND=0,7&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">!=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span> <span class="token comment">//遇到空格跳出循环	</span>
	<span class="token punctuation">{</span>
		<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pbuf<span class="token operator">++</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
	<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token char">&#39;\n&#39;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//换行	</span>
<span class="token comment">//	delay_ms(10);</span>
<span class="token punctuation">}</span>

<span class="token comment">//ESP8266-WIFI模块工作模式初始化</span>
<span class="token keyword">void</span> <span class="token function">ESP8266_ModeInit</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CWMODE=2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//设置路由器模式 1 staTIon模式 2 AP点 路由器模式 3 station+AP混合模式</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CWSAP=\&quot;PRECHIN\&quot;,\&quot;prechin168\&quot;,11,0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置WIFI热点名及密码</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CIPAP=\&quot;192.168.4.1\&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//	ESP8266_SendCmd(&quot;AT+RST&quot;);//重新启动wifi模块</span>
<span class="token comment">//	delay_ms(2000);</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CIPMUX=1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//开启多连接模式，允许多个各客户端接入</span>
	<span class="token function">ESP8266_SendCmd</span><span class="token punctuation">(</span><span class="token string">&quot;AT+CIPSERVER=1,8080&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">//启动TCP/IP 端口为8080 实现基于网络控制	</span>
<span class="token punctuation">}</span> 

<span class="token comment">//WIFI控制初始化</span>
<span class="token keyword">void</span> <span class="token function">wifi_control_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">ds18b20_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//初始化DS18B20</span>
	<span class="token function">ESP8266_ModeInit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	ES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span><span class="token comment">//允许串口中断</span>
<span class="token punctuation">}</span>

<span class="token comment">//WIFI控制</span>
<span class="token keyword">void</span> <span class="token function">wifi_control</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	u16 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
   	<span class="token keyword">int</span> temp_value<span class="token punctuation">;</span>
	u8 temp_buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	u8 wifi_send_buf<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">50</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//间隔一段时间读取温度值，间隔时间要大于温度传感器转换温度时间</span>
			temp_value<span class="token operator">=</span><span class="token function">ds18b20_read_temperture</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token number">10</span><span class="token punctuation">;</span><span class="token comment">//保留温度值小数后一位</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>temp_value<span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token comment">//负温度</span>
		<span class="token punctuation">{</span>
			temp_value<span class="token operator">=</span><span class="token operator">-</span>temp_value<span class="token punctuation">;</span>
			temp_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x40</span><span class="token punctuation">;</span><span class="token comment">//显示负号</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">&#39;-&#39;</span><span class="token punctuation">;</span>	
		<span class="token punctuation">}</span>
		<span class="token keyword">else</span>
		<span class="token punctuation">{</span>
			temp_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token number">0x00</span><span class="token punctuation">;</span><span class="token comment">//不显示</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">&#39;+&#39;</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>		
		temp_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">/</span><span class="token number">1000</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//百位</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">100</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//十位</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token operator">|</span><span class="token number">0x80</span><span class="token punctuation">;</span><span class="token comment">//个位+小数点</span>
		temp_buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span>gsmg_code<span class="token punctuation">[</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">%</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//小数点后一位</span>
		<span class="token function">smg_display</span><span class="token punctuation">(</span>temp_buf<span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">%</span><span class="token number">100</span><span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=</span>temp_value<span class="token operator">/</span><span class="token number">1000</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">;</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">/</span><span class="token number">100</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">;</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">/</span><span class="token number">10</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">;</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">&#39;.&#39;</span><span class="token punctuation">;</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token operator">=</span>temp_value<span class="token operator">%</span><span class="token number">1000</span><span class="token operator">%</span><span class="token number">100</span><span class="token operator">%</span><span class="token number">10</span><span class="token operator">+</span><span class="token number">0x30</span><span class="token punctuation">;</span>
			wifi_send_buf<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">;</span>
			<span class="token function">ESP8266_SendData</span><span class="token punctuation">(</span>wifi_send_buf<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//通过串口发送温度数据到APP	</span>
		<span class="token punctuation">}</span>		
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>

<span class="token comment">//串口中断服务函数</span>
<span class="token comment">//接收手机APP发送的信号后控制板载资源</span>
<span class="token keyword">void</span> <span class="token function">UART_IRQn</span><span class="token punctuation">(</span><span class="token punctuation">)</span> interrupt <span class="token number">4</span>
<span class="token punctuation">{</span>
	<span class="token keyword">static</span> u8 i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span><span class="token punctuation">(</span>RI<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		RI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		UART_RX_BUF<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token operator">=</span>SBUF<span class="token punctuation">;</span><span class="token comment">//读取接收到的数据</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>UART_RX_BUF<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">==</span><span class="token char">&#39;+&#39;</span><span class="token punctuation">)</span>i<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token keyword">else</span> i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span><span class="token punctuation">(</span>i<span class="token operator">==</span><span class="token number">10</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			i<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token comment">//WIFI控制</span>
			<span class="token keyword">if</span><span class="token punctuation">(</span>UART_RX_BUF<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">==</span>LED1_ON_CMD<span class="token punctuation">)</span>
				LED1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>UART_RX_BUF<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token operator">==</span>LED1_OFF_CMD<span class="token punctuation">)</span>
				LED1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>		
		<span class="token punctuation">}</span>			
	<span class="token punctuation">}</span>	
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//wifi_control.h</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifndef</span> <span class="token expression">_wifi_control_H</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">_wifi_control_H</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>


<span class="token keyword">void</span> <span class="token function">wifi_control_init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">wifi_control</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//uart.c</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;uart.h&quot;</span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RELOAD_COUNT</span> <span class="token expression"><span class="token number">0xFA</span> </span><span class="token comment">//宏定义波特率发生器的载入值 9600</span></span>

<span class="token keyword">void</span> <span class="token function">UART_Init</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	SCON<span class="token operator">|=</span><span class="token number">0X50</span><span class="token punctuation">;</span>			<span class="token comment">//设置为工作方式1</span>
	TMOD<span class="token operator">|=</span><span class="token number">0X20</span><span class="token punctuation">;</span>			<span class="token comment">//设置计数器工作方式2</span>
	PCON<span class="token operator">=</span><span class="token number">0X80</span><span class="token punctuation">;</span>			<span class="token comment">//波特率加倍</span>
	TH1<span class="token operator">=</span>RELOAD_COUNT<span class="token punctuation">;</span>	<span class="token comment">//计数器初始值设置</span>
	TL1<span class="token operator">=</span>TH1<span class="token punctuation">;</span>
	ES<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>				<span class="token comment">//关闭接收中断</span>
	EA<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">//打开总中断</span>
	TR1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>				<span class="token comment">//打开计数器</span>
<span class="token comment">//	TI=1;          //发送中断标记位，如果使用printf函数的必须设置	</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">UART_SendData</span><span class="token punctuation">(</span>u8 dat<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	ES<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//关闭串口中断</span>
	TI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//清发送完毕中断请求标志位</span>
	SBUF<span class="token operator">=</span>dat<span class="token punctuation">;</span> <span class="token comment">//发送</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span>TI<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//等待发送完毕</span>
	TI<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span class="token comment">//清发送完毕中断请求标志位</span>
	ES<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">//允许串口中断</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">UART_SendString</span><span class="token punctuation">(</span>u8 <span class="token operator">*</span>pbuf<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token operator">!=</span><span class="token char">&#39;\0&#39;</span><span class="token punctuation">)</span> <span class="token comment">//遇到空格跳出循环	</span>
	<span class="token punctuation">{</span>
		<span class="token function">UART_SendData</span><span class="token punctuation">(</span><span class="token operator">*</span>pbuf<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">delay_10us</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pbuf<span class="token operator">++</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

u8 UART_RX_BUF<span class="token punctuation">[</span>UART_REC_LEN<span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment">//接收缓冲,最大UART_REC_LEN个字节.</span>
<span class="token comment">//接收状态</span>
<span class="token comment">//bit15，	接收完成标志</span>
<span class="token comment">//bit14，	接收到0x0d</span>
<span class="token comment">//bit13~0，	接收到的有效字节数目</span>
u16 UART_RX_STA<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>       <span class="token comment">//接收状态标记	</span>


<span class="token comment">//void UART_IRQn() interrupt 4</span>
<span class="token comment">//{</span>
<span class="token comment">//	u8 r;</span>
<span class="token comment">//	static u8 i=0;</span>
<span class="token comment">//	</span>
<span class="token comment">//	if(RI)</span>
<span class="token comment">//	{</span>
<span class="token comment">//		RI=0;</span>
<span class="token comment">//		UART_RX_BUF[i]=SBUF;//读取接收到的数据</span>
<span class="token comment">//		if(UART_RX_BUF[0]==&#39;+&#39;)i++;</span>
<span class="token comment">//		else i=0;</span>
<span class="token comment">//		if(i==10)</span>
<span class="token comment">//		{</span>
<span class="token comment">//			i=0;</span>
<span class="token comment">//		}		  		</span>
<span class="token comment">//	}	</span>
<span class="token comment">//}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-c ext-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//main.c</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;public.h&quot;</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&quot;wifi_control.h&quot;</span></span>

<span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>	
	<span class="token function">wifi_control_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>				
		<span class="token function">wifi_control</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>	
	<span class="token punctuation">}</span>		
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以用手机<code>app</code>控制，设置<code>esp</code>芯片<code>ip</code>为<code>192.168.4.1:8080</code></p><p>控制 LED1 开的指令：<code>+IPD,0,1:1</code></p><p>控制 LED1 关的指令：<code>+IPD,0,1:2</code></p><p>也可以直接连接，浏览器中输入，<code>192.168.4.1:8080/+IPD,0,1:1</code>，关灯同理。</p><div class="custom-container tip"><p class="custom-container-title">注意事项</p><p>c语言静态变量的声明放到所有变量之前，否则会报错</p><p>中断函数头文件不需要声明</p><p>数据高位传输、低位传输</p><p>上升沿采样、下降沿采样</p><p>判断延时是否结束</p><p>I2C、UART、PWM</p></div></div><!--[--><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">上次更新: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">作者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 1814300923@qq.com">Chenxuwkk</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/blog/study/page11.html" class="" aria-label="Makefile"><!--[--><!--]--> Makefile <!--[--><!--]--></a></span><span class="next"><a href="/blog/study/page13.html" class="" aria-label="STM32"><!--[--><!--]--> STM32 <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/blog/assets/app.b33ca31f.js" defer></script>
  </body>
</html>
